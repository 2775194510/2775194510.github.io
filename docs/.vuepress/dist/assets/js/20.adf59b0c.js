(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{1617:function(s,t,a){"use strict";a.r(t);var n=a(1),r=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"_1-dsl查询分类"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-dsl查询分类"}},[s._v("#")]),s._v(" 1：DSL查询分类")]),s._v(" "),t("p",[s._v("Elasticsearch提供了基于JSON的DSL（"),t("a",{attrs:{href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("Domain Specific Language"),t("OutboundLink")],1),s._v("）来定义查询。常见的查询类型包括：")]),s._v(" "),t("ul",[t("li",[t("p",[t("strong",[s._v("查询所有")]),s._v("：查询出所有数据，一般测试用。例如："),t("code",[s._v("match_all")])])]),s._v(" "),t("li",[t("p",[t("strong",[s._v("全文检索（full text）查询")]),s._v("：利用分词器对用户输入内容分词，然后去倒排索引库中匹配。例如：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("match_query")])]),s._v(" "),t("li",[t("code",[s._v("multi_match_query")])])])]),s._v(" "),t("li",[t("p",[t("strong",[s._v("精确查询")]),s._v("：根据精确词条值查找数据，一般是查找keyword、数值、日期、boolean等类型字段。例如：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("ids")])]),s._v(" "),t("li",[t("code",[s._v("range")])]),s._v(" "),t("li",[t("code",[s._v("term")])])])]),s._v(" "),t("li",[t("p",[t("strong",[s._v("地理（geo）查询")]),s._v("：根据经纬度查询。例如：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("geo_distance")])]),s._v(" "),t("li",[t("code",[s._v("geo_bounding_box")])])])]),s._v(" "),t("li",[t("p",[t("strong",[s._v("复合（compound）查询")]),s._v("：复合查询可以将上述各种查询条件组合起来，合并查询条件。例如：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("bool")])]),s._v(" "),t("li",[t("code",[s._v("function_score")])])])])]),s._v(" "),t("p",[s._v("查询的语法基本一致：")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[s._v("GET /indexName/_search\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"query"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"查询类型"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"查询条件"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"条件值"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("我们以查询所有为例，其中：")]),s._v(" "),t("ul",[t("li",[s._v("查询类型为 "),t("code",[s._v("match_all")])]),s._v(" "),t("li",[s._v("没有查询条件")])]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 查询所有")]),s._v("\nGET /indexName/_search\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"query"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"match_all"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("其它查询无非就是"),t("strong",[s._v("查询类型")]),s._v("、"),t("strong",[s._v("查询条件")]),s._v("的变化。")]),s._v(" "),t("h2",{attrs:{id:"_2-全文检索查询"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-全文检索查询"}},[s._v("#")]),s._v(" 2：全文检索查询")]),s._v(" "),t("h3",{attrs:{id:"_2-1-使用场景"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-使用场景"}},[s._v("#")]),s._v(" 2.1 使用场景")]),s._v(" "),t("p",[s._v("全文检索查询的基本流程如下：")]),s._v(" "),t("ul",[t("li",[s._v("对用户搜索的内容做分词，得到词条")]),s._v(" "),t("li",[s._v("根据词条去倒排索引库中匹配，得到文档id")]),s._v(" "),t("li",[s._v("根据文档id找到文档，返回给用户")])]),s._v(" "),t("p",[s._v("比较常用的场景包括：")]),s._v(" "),t("ul",[t("li",[s._v("商城的输入框搜索")]),s._v(" "),t("li",[s._v("百度输入框搜索")])]),s._v(" "),t("p",[t("img",{attrs:{src:a(676),alt:"alt text"}})]),s._v(" "),t("p",[s._v("因为是拿着词条去匹配，因此参与搜索的字段也必须是可分词的 "),t("code",[s._v("text类型")]),s._v(" 的字段。")]),s._v(" "),t("h3",{attrs:{id:"_2-2-基本语法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-基本语法"}},[s._v("#")]),s._v(" 2.2 基本语法")]),s._v(" "),t("p",[s._v("常见的全文检索查询包括：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("match查询")]),s._v("：单字段查询")]),s._v(" "),t("li",[t("code",[s._v("multi_match查询")]),s._v("：多字段查询，任意一个字段符合条件就算符合查询条件")])]),s._v(" "),t("p",[s._v("match查询语法如下：")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[s._v("GET /indexName/_search\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"query"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"match"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"FIELD"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"TEXT"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("mulit_match语法如下：")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[s._v("GET /indexName/_search\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"query"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"multi_match"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"query"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"TEXT"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"fields"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"FIELD1"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('" FIELD12"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("h3",{attrs:{id:"_2-3-示例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-示例"}},[s._v("#")]),s._v(" 2.3 示例")]),s._v(" "),t("p",[s._v("match查询示例：")]),s._v(" "),t("p",[t("img",{attrs:{src:a(677),alt:"alt text"}})]),s._v(" "),t("p",[s._v("multi_match查询示例：")]),s._v(" "),t("p",[t("img",{attrs:{src:a(678),alt:"alt text"}})]),s._v(" "),t("p",[s._v("可以看到，两种查询结果是一样的，为什么？")]),s._v(" "),t("p",[s._v("因为我们将 "),t("code",[s._v("brand")]),s._v("、"),t("code",[s._v("name")]),s._v("、"),t("code",[s._v("business")]),s._v(" 值都利用 "),t("code",[s._v("copy_to")]),s._v(" 复制到了 "),t("code",[s._v("all")]),s._v(" 字段中。因此你根据三个字段搜索，和根据 "),t("code",[s._v("all")]),s._v(" 字段搜索效果当然一样了。")]),s._v(" "),t("p",[s._v("但是，搜索字段越多，对查询性能影响越大，因此建议采用 "),t("code",[s._v("copy_to")]),s._v("，然后单字段查询的方式。")]),s._v(" "),t("h3",{attrs:{id:"_2-4-总结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-总结"}},[s._v("#")]),s._v(" 2.4 总结")]),s._v(" "),t("p",[t("code",[s._v("match")]),s._v(" 和 "),t("code",[s._v("multi_match")]),s._v(" 的区别是什么？")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("match")]),s._v("：根据一个字段查询")]),s._v(" "),t("li",[t("code",[s._v("multi_match")]),s._v("：根据多个字段查询，参与查询字段越多，查询性能越差")])]),s._v(" "),t("h2",{attrs:{id:"_3-精确查询"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-精确查询"}},[s._v("#")]),s._v(" 3：精确查询")]),s._v(" "),t("p",[s._v("精确查询一般是查找 "),t("code",[s._v("keyword")]),s._v("、"),t("code",[s._v("数值")]),s._v("、"),t("code",[s._v("日期")]),s._v("、"),t("code",[s._v("boolean")]),s._v("等类型字段。所以"),t("strong",[s._v("不会")]),s._v("对搜索条件分词。常见的有：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("term")]),s._v("：根据词条精确值查询")]),s._v(" "),t("li",[t("code",[s._v("range")]),s._v("：根据值的范围查询")])]),s._v(" "),t("h3",{attrs:{id:"_3-1-term查询"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-term查询"}},[s._v("#")]),s._v(" 3.1 term查询")]),s._v(" "),t("p",[s._v("因为精确查询的字段搜是不分词的字段，因此查询的条件也必须是"),t("strong",[s._v("不分词")]),s._v("的词条。查询时，用户输入的内容跟自动值完全匹配时才认为符合条件。如果用户输入的内容过多，反而搜索不到数据。")]),s._v(" "),t("p",[s._v("语法说明：")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// term查询")]),s._v("\nGET /indexName/_search\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"query"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"term"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"FIELD"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"value"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"VALUE"')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("p",[s._v("示例：")]),s._v(" "),t("p",[s._v("当我搜索的是精确词条时，能正确查询出结果：")]),s._v(" "),t("p",[t("img",{attrs:{src:a(679),alt:"alt text"}})]),s._v(" "),t("p",[s._v("但是，当我搜索的内容不是词条，而是多个词语形成的短语时，反而搜索不到：")]),s._v(" "),t("p",[t("img",{attrs:{src:a(680),alt:"alt text"}})]),s._v(" "),t("h3",{attrs:{id:"_3-2-range查询"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-range查询"}},[s._v("#")]),s._v(" 3.2 range查询")]),s._v(" "),t("p",[s._v("范围查询，一般应用在对数值类型做范围过滤的时候。比如做价格范围过滤。")]),s._v(" "),t("p",[s._v("基本语法：")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// range查询")]),s._v("\nGET /indexName/_search\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"query"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"range"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"FIELD"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"gte"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 这里的gte代表大于等于，gt则代表大于")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"lte"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// lte代表小于等于，lt则代表小于")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("p",[s._v("示例：")]),s._v(" "),t("p",[t("img",{attrs:{src:a(681),alt:"alt text"}})]),s._v(" "),t("h3",{attrs:{id:"_3-3-总结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-总结"}},[s._v("#")]),s._v(" 3.3 总结")]),s._v(" "),t("p",[s._v("精确查询常见的有哪些？")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("term查询")]),s._v("：根据词条精确匹配，一般搜索keyword类型、数值类型、布尔类型、日期类型字段")]),s._v(" "),t("li",[t("code",[s._v("range查询")]),s._v("：根据数值范围查询，可以是数值、日期的范围")])]),s._v(" "),t("h2",{attrs:{id:"_4-地理坐标查询"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-地理坐标查询"}},[s._v("#")]),s._v(" 4：地理坐标查询")]),s._v(" "),t("p",[s._v("所谓的地理坐标查询，其实就是根据经纬度查询，"),t("a",{attrs:{href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-queries.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("官方文档"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("常见的使用场景包括：")]),s._v(" "),t("ul",[t("li",[s._v("携程：搜索我附近的酒店")]),s._v(" "),t("li",[s._v("滴滴：搜索我附近的出租车")]),s._v(" "),t("li",[s._v("微信：搜索我附近的人")])]),s._v(" "),t("h3",{attrs:{id:"_4-1-矩形范围查询"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-矩形范围查询"}},[s._v("#")]),s._v(" 4.1 矩形范围查询")]),s._v(" "),t("p",[s._v("矩形范围查询，也就是 "),t("code",[s._v("geo_bounding_box")]),s._v(" 查询，查询坐标落在某个矩形范围的所有文档：")]),s._v(" "),t("p",[t("img",{attrs:{src:a(682),alt:"alt text"}})]),s._v(" "),t("p",[s._v("查询时，需要指定矩形的"),t("strong",[s._v("左上")]),s._v("、"),t("strong",[s._v("右下")]),s._v("两个点的坐标，然后画出一个矩形，落在该矩形内的都是符合条件的点。")]),s._v(" "),t("p",[s._v("语法如下：")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// geo_bounding_box查询")]),s._v("\nGET /indexName/_search\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"query"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"geo_bounding_box"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"FIELD"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"top_left"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 左上点")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"lat"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("31.1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"lon"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("121.5")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"bottom_right"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 右下点")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"lat"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("30.9")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"lon"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("121.7")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])]),t("h3",{attrs:{id:"_4-2-附近查询"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-附近查询"}},[s._v("#")]),s._v(" 4.2 附近查询")]),s._v(" "),t("p",[s._v("附近查询，也叫做距离查询（ "),t("code",[s._v("geo_distance")]),s._v(" ）：查询到指定中心点小于某个距离值的所有文档。")]),s._v(" "),t("p",[s._v("换句话来说，在地图上找一个点作为圆心，以指定距离为半径，画一个圆，落在圆内的坐标都算符合条件：")]),s._v(" "),t("p",[t("img",{attrs:{src:a(683),alt:"alt text"}}),s._v("\n语法说明：")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// geo_distance 查询")]),s._v("\nGET /indexName/_search\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"query"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"geo_distance"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"distance"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"15km"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 半径")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"FIELD"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"31.21,121.5"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 圆心")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[s._v("示例")]),s._v(" "),t("p",[s._v("我们先搜索陆家嘴附近15km的酒店：")]),s._v(" "),t("p",[t("img",{attrs:{src:a(684),alt:"alt text"}})]),s._v(" "),t("p",[s._v("发现共有47家酒店。")]),s._v(" "),t("p",[s._v("然后把半径缩短到3公里：")]),s._v(" "),t("p",[t("img",{attrs:{src:a(685),alt:"alt text"}})]),s._v(" "),t("p",[s._v("可以发现，搜索到的酒店数量减少到了5家。")]),s._v(" "),t("h2",{attrs:{id:"_5-复合查询"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-复合查询"}},[s._v("#")]),s._v(" 5：复合查询")]),s._v(" "),t("p",[s._v("复合（compound）查询：复合查询可以将其它简单查询组合起来，实现更复杂的搜索逻辑。常见的有两种：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("fuction score")]),s._v("：算分函数查询，可以控制文档相关性算分，控制文档排名")]),s._v(" "),t("li",[t("code",[s._v("bool query")]),s._v("：布尔查询，利用逻辑关系组合多个其它的查询，实现复杂搜索")])]),s._v(" "),t("h3",{attrs:{id:"_5-1-相关性算分"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-相关性算分"}},[s._v("#")]),s._v(" 5.1 相关性算分")]),s._v(" "),t("p",[s._v("当我们利用 "),t("code",[s._v("match")]),s._v(" 查询时，文档结果会根据与搜索词条的关联度打分（_score），返回结果时按照分值降序排列。")]),s._v(" "),t("p",[s._v('例如，我们搜索 "虹桥如家"，结果如下：')]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"_score"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17.850193")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"_source"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"name"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"虹桥如家酒店真不错"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"_score"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12.259849")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"_source"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"name"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"外滩如家酒店真不错"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"_score"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11.91091")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"_source"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"name"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"迪士尼如家酒店真不错"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br")])]),t("p",[s._v("在elasticsearch中，早期使用的打分算法是TF-IDF算法，公式如下：")]),s._v(" "),t("p",[t("img",{attrs:{src:a(686),alt:"alt text"}})]),s._v(" "),t("p",[s._v("在后来的5.1版本升级中，elasticsearch将算法改进为BM25算法，公式如下：")]),s._v(" "),t("p",[t("img",{attrs:{src:a(687),alt:"alt text"}})]),s._v(" "),t("p",[s._v("TF-IDF算法有一各缺陷，就是词条频率越高，文档得分也会越高，单个词条对文档影响较大。而BM25则会让单个词条的算分有一个上限，曲线更加平滑：")]),s._v(" "),t("p",[t("img",{attrs:{src:a(688),alt:"alt text"}})]),s._v(" "),t("p",[s._v("小结：elasticsearch会根据词条和文档的相关度做打分，算法由两种：")]),s._v(" "),t("ul",[t("li",[s._v("TF-IDF算法")]),s._v(" "),t("li",[s._v("BM25算法，elasticsearch5.1版本后采用的算法")])]),s._v(" "),t("h3",{attrs:{id:"_5-2-算分函数查询"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-算分函数查询"}},[s._v("#")]),s._v(" 5.2 算分函数查询")]),s._v(" "),t("p",[s._v("根据相关度打分是比较合理的需求，但"),t("strong",[s._v("合理的不一定是产品经理需要")]),s._v("的。")]),s._v(" "),t("p",[s._v("以百度为例，你搜索的结果中，并不是相关度越高排名越靠前，而是谁掏的钱多排名就越靠前。如图：")]),s._v(" "),t("p",[t("img",{attrs:{src:a(689),alt:"alt text"}})]),s._v(" "),t("p",[s._v("要想认为控制相关性算分，就需要利用 "),t("code",[s._v("elasticsearch")]),s._v(" 中的 "),t("code",[s._v("function score")]),s._v(" 查询了。")]),s._v(" "),t("h4",{attrs:{id:"_1-语法说明"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-语法说明"}},[s._v("#")]),s._v(" 1）语法说明")]),s._v(" "),t("p",[t("img",{attrs:{src:a(690),alt:"alt text"}})]),s._v(" "),t("p",[s._v("function score 查询中包含四部分内容：")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("原始查询")]),s._v("条件：query部分，基于这个条件搜索文档，并且基于BM25算法给文档打分，"),t("strong",[s._v("原始算分")]),s._v("（query score）")]),s._v(" "),t("li",[t("strong",[s._v("过滤条件")]),s._v("：filter部分，符合该条件的文档才会重新算分")]),s._v(" "),t("li",[t("strong",[s._v("算分函数")]),s._v("：符合filter条件的文档要根据这个函数做运算，得到的"),t("strong",[s._v("函数算分")]),s._v("（function score），有四种函数\n"),t("ul",[t("li",[s._v("weight：函数结果是常量")]),s._v(" "),t("li",[s._v("field_value_factor：以文档中的某个字段值作为函数结果")]),s._v(" "),t("li",[s._v("random_score：以随机数作为函数结果")]),s._v(" "),t("li",[s._v("script_score：自定义算分函数算法")])])]),s._v(" "),t("li",[t("strong",[s._v("运算模式")]),s._v("：算分函数的结果、原始查询的相关性算分，两者之间的运算方式，包括：\n"),t("ul",[t("li",[s._v("multiply：相乘")]),s._v(" "),t("li",[s._v("replace：用function score替换query score")]),s._v(" "),t("li",[s._v("其它，例如：sum、avg、max、min")])])])]),s._v(" "),t("p",[s._v("function score的运行流程如下：")]),s._v(" "),t("ul",[t("li",[s._v("1）根据"),t("strong",[s._v("原始条件")]),s._v("查询搜索文档，并且计算相关性算分，称为"),t("strong",[s._v("原始算分")]),s._v("（query score）")]),s._v(" "),t("li",[s._v("2）根据"),t("strong",[s._v("过滤条件")]),s._v("，过滤文档")]),s._v(" "),t("li",[s._v("3）符合"),t("strong",[s._v("过滤条件")]),s._v("的文档，基于"),t("strong",[s._v("算分函数")]),s._v("运算，得到"),t("strong",[s._v("函数算分")]),s._v("（function score）")]),s._v(" "),t("li",[s._v("4）将"),t("strong",[s._v("原始算分")]),s._v("（query score）和"),t("strong",[s._v("函数算分")]),s._v("（function score）基于"),t("strong",[s._v("运算模式")]),s._v("做运算，得到最终结果，作为相关性算分。")])]),s._v(" "),t("p",[s._v("因此，其中的关键点是：")]),s._v(" "),t("ul",[t("li",[s._v("过滤条件：决定哪些文档的算分被修改")]),s._v(" "),t("li",[s._v("算分函数：决定函数算分的算法")]),s._v(" "),t("li",[s._v("运算模式：决定最终算分结果")])]),s._v(" "),t("h4",{attrs:{id:"_2-示例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-示例"}},[s._v("#")]),s._v(" 2）示例")]),s._v(" "),t("p",[s._v("需求：给“如家”这个品牌的酒店排名靠前一些")]),s._v(" "),t("p",[s._v("翻译一下这个需求，转换为之前说的四个要点：")]),s._v(" "),t("ul",[t("li",[s._v("原始条件：不确定，可以任意变化")]),s._v(" "),t("li",[s._v('过滤条件：brand = "如家"')]),s._v(" "),t("li",[s._v("算分函数：可以简单粗暴，直接给固定的算分结果，weight")]),s._v(" "),t("li",[s._v("运算模式：比如求和")])]),s._v(" "),t("p",[s._v("因此最终的DSL语句如下：")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[s._v("GET /hotel/_search\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"query"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"function_score"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"query"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("  .... "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 原始查询，可以是任意条件")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"functions"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 算分函数")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"filter"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 满足的条件，品牌必须是如家")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"term"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n              "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"brand"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"如家"')]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"weight"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 算分权重为2")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"boost_mode"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sum"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 加权模式，求和")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br")])]),t("p",[s._v("测试，在未添加算分函数时，如家得分如下：")]),s._v(" "),t("p",[t("img",{attrs:{src:a(691),alt:"alt text"}})]),s._v(" "),t("p",[s._v("添加了算分函数后，如家得分就提升了：")]),s._v(" "),t("p",[t("img",{attrs:{src:a(692),alt:"alt text"}})]),s._v(" "),t("h4",{attrs:{id:"_3-小结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-小结"}},[s._v("#")]),s._v(" 3）小结")]),s._v(" "),t("p",[s._v("function score query定义的三要素是什么？")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("过滤条件")]),s._v("：哪些文档要加分")]),s._v(" "),t("li",[t("strong",[s._v("算分函数")]),s._v("：如何计算function score")]),s._v(" "),t("li",[t("strong",[s._v("加权方式")]),s._v("：function score 与 query score如何运算")])]),s._v(" "),t("h3",{attrs:{id:"_5-3-布尔查询"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-布尔查询"}},[s._v("#")]),s._v(" 5.3 布尔查询")]),s._v(" "),t("p",[s._v("布尔查询是一个或多个查询子句的组合，每一个子句就是一个"),t("strong",[s._v("子查询")]),s._v("。子查询的组合方式有：")]),s._v(" "),t("ul",[t("li",[s._v("must：必须匹配每个子查询，类似“与”")]),s._v(" "),t("li",[s._v("should：选择性匹配子查询，类似“或”")]),s._v(" "),t("li",[s._v("must_not：必须不匹配，"),t("strong",[s._v("不参与算分")]),s._v("，类似“非”")]),s._v(" "),t("li",[s._v("filter：必须匹配，"),t("strong",[s._v("不参与算分")])])]),s._v(" "),t("p",[s._v("比如在搜索酒店时，除了关键字搜索外，我们还可能根据品牌、价格、城市等字段做过滤：")]),s._v(" "),t("p",[t("img",{attrs:{src:a(693),alt:"alt text"}})]),s._v(" "),t("p",[s._v("每一个不同的字段，其查询的条件、方式都不一样，必须是多个不同的查询，而要组合这些查询，就必须用bool查询了。")]),s._v(" "),t("p",[s._v("需要注意的是，搜索时，参与"),t("strong",[s._v("打分的字段越多，查询的性能也越差")]),s._v("。因此这种多条件查询时，建议这样做：")]),s._v(" "),t("ul",[t("li",[s._v("搜索框的关键字搜索，是全文检索查询，使用must查询，参与算分")]),s._v(" "),t("li",[s._v("其它过滤条件，采用filter查询。不参与算分")])]),s._v(" "),t("h4",{attrs:{id:"_1-语法示例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-语法示例"}},[s._v("#")]),s._v(" 1）语法示例：")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[s._v("GET /hotel/_search\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"query"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"bool"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"must"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"term"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"city"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"上海"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"should"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"term"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"brand"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"皇冠假日"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"term"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"brand"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"华美达"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"must_not"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"range"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"price"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"lte"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("500")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"filter"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"range"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"score"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"gte"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("45")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br")])]),t("h4",{attrs:{id:"_2-示例-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-示例-2"}},[s._v("#")]),s._v(" 2）示例")]),s._v(" "),t("p",[s._v("需求：搜索名字包含“如家”，价格不高于400，在坐标31.21,121.5周围10km范围内的酒店。")]),s._v(" "),t("p",[s._v("分析：")]),s._v(" "),t("ul",[t("li",[s._v("名称搜索，属于全文检索查询，应该参与算分。放到must中")]),s._v(" "),t("li",[s._v("价格不高于400，用range查询，属于过滤条件，不参与算分。放到must_not中")]),s._v(" "),t("li",[s._v("周围10km范围内，用geo_distance查询，属于过滤条件，不参与算分。放到filter中")])]),s._v(" "),t("p",[t("img",{attrs:{src:a(694),alt:"alt text"}})]),s._v(" "),t("h4",{attrs:{id:"_3-小结-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-小结-2"}},[s._v("#")]),s._v(" 3）小结")]),s._v(" "),t("p",[s._v("bool查询有几种逻辑关系？")]),s._v(" "),t("ul",[t("li",[s._v("must：必须匹配的条件，可以理解为“与”")]),s._v(" "),t("li",[s._v("should：选择性匹配的条件，可以理解为“或”")]),s._v(" "),t("li",[s._v("must_not：必须不匹配的条件，不参与打分")]),s._v(" "),t("li",[s._v("filter：必须匹配的条件，不参与打分")])])])}),[],!1,null,null,null);t.default=r.exports},676:function(s,t,a){s.exports=a.p+"assets/img/image43.ad86f47b.png"},677:function(s,t,a){s.exports=a.p+"assets/img/image44.ca7afe70.png"},678:function(s,t,a){s.exports=a.p+"assets/img/image45.8f5126a0.png"},679:function(s,t,a){s.exports=a.p+"assets/img/image46.4ae9e286.png"},680:function(s,t,a){s.exports=a.p+"assets/img/image47.05703b41.png"},681:function(s,t,a){s.exports=a.p+"assets/img/image48.4a454b71.png"},682:function(s,t,a){s.exports=a.p+"assets/img/DKV9HZbVS6.6795efdd.gif"},683:function(s,t,a){s.exports=a.p+"assets/img/vZrdKAh19C.c79bc4a9.gif"},684:function(s,t,a){s.exports=a.p+"assets/img/image49.f8673ff1.png"},685:function(s,t,a){s.exports=a.p+"assets/img/image50.24bd3cc6.png"},686:function(s,t,a){s.exports=a.p+"assets/img/image51.f52710d3.png"},687:function(s,t,a){s.exports=a.p+"assets/img/image52.fc8772d5.png"},688:function(s,t,a){s.exports=a.p+"assets/img/image53.87a5af18.png"},689:function(s,t,a){s.exports=a.p+"assets/img/image54.6c188dd7.png"},690:function(s,t,a){s.exports=a.p+"assets/img/image55.210e5403.png"},691:function(s,t,a){s.exports=a.p+"assets/img/image56.bc48800b.png"},692:function(s,t,a){s.exports=a.p+"assets/img/image57.46b22cad.png"},693:function(s,t,a){s.exports=a.p+"assets/img/image58.c5a0da90.png"},694:function(s,t,a){s.exports=a.p+"assets/img/image59.9d0cfcdc.png"}}]);