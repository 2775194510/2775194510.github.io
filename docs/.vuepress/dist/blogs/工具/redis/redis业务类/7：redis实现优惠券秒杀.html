<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>7：redis实现优惠券秒杀 | 小泽认真奋进</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/xiaoze-blog/assets/css/0.styles.aa94598e.css" as="style"><link rel="preload" href="/xiaoze-blog/assets/js/app.eba831d4.js" as="script"><link rel="preload" href="/xiaoze-blog/assets/js/10.e507b461.js" as="script"><link rel="preload" href="/xiaoze-blog/assets/js/1.faeb34d2.js" as="script"><link rel="preload" href="/xiaoze-blog/assets/js/6.7b12d30e.js" as="script"><link rel="prefetch" href="/xiaoze-blog/assets/js/100.e6affe9e.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/101.d1cfdedd.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/102.20ce6f25.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/103.a9bf0cf1.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/104.31429394.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/105.84588898.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/106.f92533f0.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/107.119b53a9.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/108.86e02d27.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/109.55119d38.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/11.aeac973f.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/110.055317e0.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/111.3acbe385.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/112.ed5237ac.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/113.6a2a51f8.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/114.e65078e1.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/115.74ab747b.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/116.a1e43fc8.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/117.64628617.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/118.3b3857a6.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/119.aebe2b45.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/12.39e5f2f4.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/120.78532178.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/121.318fbf02.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/122.78766d28.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/123.eb7f00a2.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/124.ead61162.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/125.0294d16f.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/126.fce5f5e8.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/127.02db172a.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/128.d4384688.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/129.ef0e3626.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/13.03eca319.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/130.6f364972.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/131.d43cd67a.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/132.8a7ab13d.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/133.fb447b76.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/134.0a8e498a.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/135.6955876d.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/136.b8979f51.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/137.40d52b94.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/138.ae9134ed.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/139.5f1e7b7d.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/14.e3cafd4f.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/140.954aa220.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/141.99e141d9.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/142.3a0904c4.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/143.181e27d6.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/144.674bc897.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/145.26b1399c.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/146.7e31db9e.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/147.247d79b1.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/148.28598f33.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/149.69cec7e4.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/15.5ed4b9e8.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/150.af2e0bff.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/151.c3524cf9.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/152.c4fac654.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/153.28522857.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/154.335e01fa.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/155.581054e3.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/156.98d71a47.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/157.38dee3d5.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/158.2d009372.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/159.40f36df1.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/16.239b384c.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/160.ab112a19.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/161.5941a794.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/162.169a2b2d.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/163.81cbe974.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/164.20f65d33.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/165.73618dfa.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/166.8c7753a2.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/167.c50db752.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/168.df5f25c4.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/169.d7a2325a.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/17.26248fa2.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/170.a8384f27.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/171.2782ee6b.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/172.954644ca.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/173.d0e9aa1d.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/174.fdd8a811.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/175.f91b15df.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/176.e8d6688e.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/177.5aa3c1a2.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/178.e0542e1b.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/179.95af3b81.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/18.ab97c450.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/180.bd6f2daf.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/181.3bd0033e.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/182.54141650.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/183.7c3ebefb.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/184.4b289312.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/185.fa3ba84e.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/19.335e7e8f.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/20.47e8852b.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/21.e6caf116.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/22.9be4fc8a.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/23.ba3120e8.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/24.9f6370d7.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/25.959fd3a6.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/26.49ea2fd7.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/27.62694dcf.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/28.36858c3f.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/29.bbdaa851.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/3.7cf201e8.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/30.4cdf9f97.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/31.b7132e86.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/32.0d20f13b.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/33.70af3547.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/34.4558fec6.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/35.11b96177.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/36.abd4d367.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/37.63e689eb.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/38.6e866658.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/39.e737f6c6.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/4.17c8e94c.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/40.97cadb65.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/41.b9a3d961.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/42.2dca5683.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/43.c4542e25.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/44.5c76ee63.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/45.6fb8d306.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/46.a1b8d9d7.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/47.85afd4b1.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/48.e9751779.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/49.ce3e3b32.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/5.35ac6d83.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/50.150717a4.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/51.b90313d6.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/52.4c088c95.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/53.40becf00.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/54.1fe2b207.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/55.6e1a3df5.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/56.a25ba210.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/57.b8274411.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/58.e3153c60.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/59.b1081eca.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/60.c0f27b97.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/61.61c4a0c0.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/62.23ff8a66.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/63.4e955429.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/64.591c26bb.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/65.f7e04216.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/66.67f8f8df.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/67.d13b6918.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/68.159d7bad.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/69.017dadaa.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/7.0561e3d1.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/70.daec11de.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/71.58c714a3.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/72.15e7d7b6.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/73.744432dc.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/74.21dbc942.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/75.ea704181.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/76.922ce383.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/77.c994b8ef.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/78.959cb3cb.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/79.cb51b0fa.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/8.5a8c9d0c.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/80.20285cf9.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/81.7e6b1698.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/82.21dda659.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/83.a0430983.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/84.845507ba.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/85.3f451b63.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/86.704e0a8f.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/87.4c338144.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/88.16c9f567.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/89.9ee91fd3.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/9.90fb1b67.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/90.2a236752.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/91.c5dc1206.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/92.bf6256c5.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/93.7beafbdf.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/94.85c2678b.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/95.c78d430f.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/96.f9a35127.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/97.ebf7ade2.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/98.f8882c4c.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/99.89353994.js">
    <link rel="stylesheet" href="/xiaoze-blog/assets/css/0.styles.aa94598e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>小泽认真奋进</h3> <p class="description" data-v-59e6cb88></p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2023
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/xiaoze-blog/" class="home-link router-link-active"><img src="/xiaoze-blog/logo.png" alt="小泽认真奋进" class="logo"> <span class="site-name">小泽认真奋进</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/xiaoze-blog/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      必备知识
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/python/" class="nav-link"><i class="undefined"></i>
  python
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/gitee/" class="nav-link"><i class="undefined"></i>
  gitee
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/Linux/" class="nav-link"><i class="undefined"></i>
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/lua/" class="nav-link"><i class="undefined"></i>
  lua
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/后端/" class="nav-link"><i class="undefined"></i>
  后端
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/前端/" class="nav-link"><i class="undefined"></i>
  前端
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/jQuery/" class="nav-link"><i class="undefined"></i>
  jQuery
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/nginx/" class="nav-link"><i class="undefined"></i>
  nginx
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/juc/" class="nav-link"><i class="undefined"></i>
  juc
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/rabbit/" class="nav-link"><i class="undefined"></i>
  rabbit
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/rocket/" class="nav-link"><i class="undefined"></i>
  rocket
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/Flink/" class="nav-link"><i class="undefined"></i>
  Flink
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/cmd/" class="nav-link"><i class="undefined"></i>
  cmd
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/markdown语法/" class="nav-link"><i class="undefined"></i>
  markdown语法
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/css/" class="nav-link"><i class="undefined"></i>
  css
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/vue/" class="nav-link"><i class="undefined"></i>
  vue
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/spring/" class="nav-link"><i class="undefined"></i>
  spring
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/数据库/" class="nav-link"><i class="undefined"></i>
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/算法/" class="nav-link"><i class="undefined"></i>
  算法
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/运维/" class="nav-link"><i class="undefined"></i>
  运维
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/面经/" class="nav-link"><i class="undefined"></i>
  面经
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      前端
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/前端/jquery.html" class="nav-link"><i class="undefined"></i>
  jQuery笔记
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/前端/vue2/vue2.html" class="nav-link"><i class="undefined"></i>
  vue2
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/前端/vue3/vue3.html" class="nav-link"><i class="undefined"></i>
  vue3
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/前端/ES6/ES6语法.html" class="nav-link"><i class="undefined"></i>
  ES6
</a></li><li class="dropdown-item"><!----> <a href="https://www.baidu.com/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  其它链接
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      后端
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/java/Java面向对象.html" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/juc/1：线程基础.html" class="nav-link"><i class="undefined"></i>
  Juc
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/mybatis/1：mybatis入门教程.html" class="nav-link"><i class="undefined"></i>
  Mybatis
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/mybatisPlus/1：mybatisPlus相关业务.html" class="nav-link"><i class="undefined"></i>
  MybatisPlus
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/redis/redis基本数据类型.html" class="nav-link"><i class="undefined"></i>
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/spring/1：SpringAop.html" class="nav-link"><i class="undefined"></i>
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/springboot/1：SpringBoot拦截器.html" class="nav-link"><i class="undefined"></i>
  SpringBoot
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/springcloud/1：springcloud入门.html" class="nav-link"><i class="undefined"></i>
  SpringCloud
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/rabbitmq/1：RabbitMq.html" class="nav-link"><i class="undefined"></i>
  消息中间件
</a></li><li class="dropdown-item"><!----> <a href="https://www.baidu.com/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  其它链接
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      大数据
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/大数据/Flink/1：Flink概述.html" class="nav-link"><i class="undefined"></i>
  flink
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      运维
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/运维/docker/1：docker安装部署.html" class="nav-link"><i class="undefined"></i>
  docker
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      数据库
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/数据库/mysql/mysql基本语法.html" class="nav-link"><i class="undefined"></i>
  Mysql
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/数据库/oracle/oracle基本语法.html" class="nav-link"><i class="undefined"></i>
  Oracle
</a></li><li class="dropdown-item"><!----> <a href="https://www.runoob.com/mysql/mysql-tutorial.html" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  学习链接
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      算法
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/算法/java/Java算法.html" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/算法/MySQL/MySQL算法.html" class="nav-link"><i class="undefined"></i>
  Mysql
</a></li><li class="dropdown-item"><!----> <a href="https://leetcode.cn/problemset/all/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  刷题链接
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/xiaoze-blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      其他
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/其他/maven基本知识.html" class="nav-link"><i class="undefined"></i>
  maven
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/其他/gitee.html" class="nav-link"><i class="undefined"></i>
  gitee
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/其他/linux.html" class="nav-link"><i class="undefined"></i>
  linux
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/其他/Nginx.html" class="nav-link"><i class="undefined"></i>
  nginx
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/其他/lua脚本.html" class="nav-link"><i class="undefined"></i>
  lua
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/python/基本语法/1：基本数据类型.html" class="nav-link"><i class="undefined"></i>
  python
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      好玩的东西
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/好玩的东西/cmd命令/1：cmd打开本地电脑文件.html" class="nav-link"><i class="undefined"></i>
  电脑杂货铺
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/好玩的东西/markdown语法/markdown.html" class="nav-link"><i class="undefined"></i>
  markdown语法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      工具集合
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/工具/css/h5/h5.html" class="nav-link"><i class="undefined"></i>
  常用css
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/工具/spring/springboot/自定义注解/1：自定义校验字段注解.html" class="nav-link"><i class="undefined"></i>
  spring工具
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/工具/redis/redis工具类/1：redisUtils快捷操作redis.html" class="nav-link"><i class="undefined"></i>
  redis工具
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/面试/Java基础上.html" class="nav-link"><i class="undefined"></i>
  面试大全
</a></li></ul></div></div><div class="nav-item"><a href="/xiaoze-blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/xiaoze-blog/titletop.jpg" alt="author-avatar" class="personal-img" data-v-1fad0c41> <!----> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>173</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>36</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41><li class="social-item" data-v-1fad0c41><i class="iconfont reco-github" style="color:#e15b64;" data-v-1fad0c41></i></li><li class="social-item" data-v-1fad0c41><i class="iconfont reco-mayun" style="color:#f26d6d;" data-v-1fad0c41></i></li><li class="social-item" data-v-1fad0c41><i class="iconfont reco-csdn" style="color:#e15b64;" data-v-1fad0c41></i></li></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/xiaoze-blog/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      必备知识
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/python/" class="nav-link"><i class="undefined"></i>
  python
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/gitee/" class="nav-link"><i class="undefined"></i>
  gitee
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/Linux/" class="nav-link"><i class="undefined"></i>
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/lua/" class="nav-link"><i class="undefined"></i>
  lua
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/后端/" class="nav-link"><i class="undefined"></i>
  后端
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/前端/" class="nav-link"><i class="undefined"></i>
  前端
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/jQuery/" class="nav-link"><i class="undefined"></i>
  jQuery
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/nginx/" class="nav-link"><i class="undefined"></i>
  nginx
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/juc/" class="nav-link"><i class="undefined"></i>
  juc
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/rabbit/" class="nav-link"><i class="undefined"></i>
  rabbit
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/rocket/" class="nav-link"><i class="undefined"></i>
  rocket
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/Flink/" class="nav-link"><i class="undefined"></i>
  Flink
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/cmd/" class="nav-link"><i class="undefined"></i>
  cmd
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/markdown语法/" class="nav-link"><i class="undefined"></i>
  markdown语法
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/css/" class="nav-link"><i class="undefined"></i>
  css
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/vue/" class="nav-link"><i class="undefined"></i>
  vue
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/spring/" class="nav-link"><i class="undefined"></i>
  spring
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/数据库/" class="nav-link"><i class="undefined"></i>
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/算法/" class="nav-link"><i class="undefined"></i>
  算法
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/运维/" class="nav-link"><i class="undefined"></i>
  运维
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/categories/面经/" class="nav-link"><i class="undefined"></i>
  面经
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      前端
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/前端/jquery.html" class="nav-link"><i class="undefined"></i>
  jQuery笔记
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/前端/vue2/vue2.html" class="nav-link"><i class="undefined"></i>
  vue2
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/前端/vue3/vue3.html" class="nav-link"><i class="undefined"></i>
  vue3
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/前端/ES6/ES6语法.html" class="nav-link"><i class="undefined"></i>
  ES6
</a></li><li class="dropdown-item"><!----> <a href="https://www.baidu.com/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  其它链接
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      后端
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/java/Java面向对象.html" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/juc/1：线程基础.html" class="nav-link"><i class="undefined"></i>
  Juc
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/mybatis/1：mybatis入门教程.html" class="nav-link"><i class="undefined"></i>
  Mybatis
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/mybatisPlus/1：mybatisPlus相关业务.html" class="nav-link"><i class="undefined"></i>
  MybatisPlus
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/redis/redis基本数据类型.html" class="nav-link"><i class="undefined"></i>
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/spring/1：SpringAop.html" class="nav-link"><i class="undefined"></i>
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/springboot/1：SpringBoot拦截器.html" class="nav-link"><i class="undefined"></i>
  SpringBoot
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/springcloud/1：springcloud入门.html" class="nav-link"><i class="undefined"></i>
  SpringCloud
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/rabbitmq/1：RabbitMq.html" class="nav-link"><i class="undefined"></i>
  消息中间件
</a></li><li class="dropdown-item"><!----> <a href="https://www.baidu.com/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  其它链接
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      大数据
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/大数据/Flink/1：Flink概述.html" class="nav-link"><i class="undefined"></i>
  flink
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      运维
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/运维/docker/1：docker安装部署.html" class="nav-link"><i class="undefined"></i>
  docker
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      数据库
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/数据库/mysql/mysql基本语法.html" class="nav-link"><i class="undefined"></i>
  Mysql
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/数据库/oracle/oracle基本语法.html" class="nav-link"><i class="undefined"></i>
  Oracle
</a></li><li class="dropdown-item"><!----> <a href="https://www.runoob.com/mysql/mysql-tutorial.html" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  学习链接
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      算法
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/算法/java/Java算法.html" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/算法/MySQL/MySQL算法.html" class="nav-link"><i class="undefined"></i>
  Mysql
</a></li><li class="dropdown-item"><!----> <a href="https://leetcode.cn/problemset/all/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  刷题链接
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/xiaoze-blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      其他
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/其他/maven基本知识.html" class="nav-link"><i class="undefined"></i>
  maven
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/其他/gitee.html" class="nav-link"><i class="undefined"></i>
  gitee
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/其他/linux.html" class="nav-link"><i class="undefined"></i>
  linux
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/其他/Nginx.html" class="nav-link"><i class="undefined"></i>
  nginx
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/其他/lua脚本.html" class="nav-link"><i class="undefined"></i>
  lua
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/python/基本语法/1：基本数据类型.html" class="nav-link"><i class="undefined"></i>
  python
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      好玩的东西
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/好玩的东西/cmd命令/1：cmd打开本地电脑文件.html" class="nav-link"><i class="undefined"></i>
  电脑杂货铺
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/好玩的东西/markdown语法/markdown.html" class="nav-link"><i class="undefined"></i>
  markdown语法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      工具集合
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/工具/css/h5/h5.html" class="nav-link"><i class="undefined"></i>
  常用css
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/工具/spring/springboot/自定义注解/1：自定义校验字段注解.html" class="nav-link"><i class="undefined"></i>
  spring工具
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/工具/redis/redis工具类/1：redisUtils快捷操作redis.html" class="nav-link"><i class="undefined"></i>
  redis工具
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/面试/Java基础上.html" class="nav-link"><i class="undefined"></i>
  面试大全
</a></li></ul></div></div><div class="nav-item"><a href="/xiaoze-blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>常用工具大全</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>css</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-2"><p class="sidebar-heading open"><span>h5</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xiaoze-blog/blogs/工具/css/h5/h5.html" class="sidebar-link">1-h5常用css总结</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-2"><p class="sidebar-heading"><span>vue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xiaoze-blog/blogs/工具/css/vue/vue杂货铺.html" class="sidebar-link">1-vue杂货铺</a></li><li><a href="/xiaoze-blog/blogs/工具/css/vue/vue模板.html" class="sidebar-link">2-vue常用模板总结</a></li><li><a href="/xiaoze-blog/blogs/工具/css/vue/vue常用css.html" class="sidebar-link">3-vue常用css总结</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>redis知识库</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-2"><p class="sidebar-heading"><span>redis工具类</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xiaoze-blog/blogs/工具/redis/redis工具类/1：redisUtils快捷操作redis.html" class="sidebar-link">1：redisUtils快捷操作redis</a></li><li><a href="/xiaoze-blog/blogs/工具/redis/redis工具类/2：批量操作redis工具类.html" class="sidebar-link">2：批量操作redis工具类</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-2"><p class="sidebar-heading open"><span>redis业务类</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xiaoze-blog/blogs/工具/redis/redis业务类/1：用redis生成唯一自增id.html" class="sidebar-link">1：用redis生成唯一自增id</a></li><li><a href="/xiaoze-blog/blogs/工具/redis/redis业务类/2：用redis防止按钮重复提交.html" class="sidebar-link">2：用redis防止按钮重复提交</a></li><li><a href="/xiaoze-blog/blogs/工具/redis/redis业务类/3：基于Redis实现共享Session登录.html" class="sidebar-link">3：基于Redis实现共享Session登录</a></li><li><a href="/xiaoze-blog/blogs/工具/redis/redis业务类/4：redis实现点赞排行榜.html" class="sidebar-link">4：redis实现点赞排行榜</a></li><li><a href="/xiaoze-blog/blogs/工具/redis/redis业务类/5：redis实现共同好友或者共同关注.html" class="sidebar-link">5：redis实现共同好友或者共同关注</a></li><li><a href="/xiaoze-blog/blogs/工具/redis/redis业务类/6：redis实现用户签到以及签到统计.html" class="sidebar-link">6：redis实现用户签到以及签到统计</a></li><li><a href="/xiaoze-blog/blogs/工具/redis/redis业务类/7：redis实现优惠券秒杀.html" class="active sidebar-link">7：redis实现优惠券秒杀</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>spring</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-2"><p class="sidebar-heading open"><span>springboot</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-3"><p class="sidebar-heading open"><span>开发必备</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/开发必备/1：maven包大全.html" class="sidebar-link">1：maven包大全</a></li><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/开发必备/2：application.yml.html" class="sidebar-link">2：application.yml.</a></li><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/开发必备/3：SpringBoot统一解决跨域处理.html" class="sidebar-link">3：SpringBoot统一解决跨域处理</a></li><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/开发必备/4：SpringBoot统一解决异常处理.html" class="sidebar-link">4：SpringBoot统一解决异常处理</a></li><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/开发必备/5：公共类.html" class="sidebar-link">5：公共类</a></li><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/开发必备/6：SpringBoot读取yml文件.html" class="sidebar-link">6：SpringBoot读取yml文件</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-3"><p class="sidebar-heading"><span>业务需求</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/业务需求/1：开发小工具.html" class="sidebar-link">1：开发小工具</a></li><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/业务需求/2：常用sql大全.html" class="sidebar-link">2：常用sql大全</a></li><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/业务需求/3：SpringBoot启动时加载数据库数据到redis.html" class="sidebar-link">3：SpringBoot启动时加载数据库数据到redis</a></li><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/业务需求/4：SpringBoot启动时加载数据库数据到项目中.html" class="sidebar-link">4：SpringBoot启动时加载数据库数据到项目中</a></li><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/业务需求/5：Springboot集成Jaxb加载数据到xml.html" class="sidebar-link">5：Springboot集成Jaxb加载数据到xml</a></li><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/业务需求/6：接受、发送xml报文.html" class="sidebar-link">6：接受、发送xml报文</a></li><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/业务需求/7：结合mapStruct实现JavaBean转换.html" class="sidebar-link">7：结合mapStruct实现JavaBean转换</a></li><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/业务需求/8：调用三方接口示例实现.html" class="sidebar-link">8：调用三方接口示例实现</a></li><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/业务需求/9：数据脱敏.html" class="sidebar-link">9：数据脱敏</a></li><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/业务需求/10：接口失败重试机制实现.html" class="sidebar-link">10：接口失败重试机制实现</a></li><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/业务需求/11：大文件上传.html" class="sidebar-link">11：大文件上传</a></li><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/业务需求/12：springboot上传文件至本地.html" class="sidebar-link">12：springboot上传文件至本地</a></li><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/业务需求/13：订单自动取消的11种实现方式.html" class="sidebar-link">13：订单自动取消的11种实现方式</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-3"><p class="sidebar-heading"><span>自定义注解</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/自定义注解/1：自定义校验字段注解.html" class="sidebar-link">1：自定义校验字段注解</a></li><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/自定义注解/2：统计方法执行时间注解.html" class="sidebar-link">2：统计方法执行时间注解</a></li><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/自定义注解/3：设置接口访问频率.html" class="sidebar-link">3：设置接口访问频率</a></li><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/自定义注解/4：SpringBoot+Vue实现数据加密.html" class="sidebar-link">4：SpringBoot+Vue实现数据加密</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-3"><p class="sidebar-heading"><span>整合三方</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/整合三方/1：springboot整合easyExcel.html" class="sidebar-link">1：springboot整合easyExcel</a></li><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/整合三方/2：springboot整合word.html" class="sidebar-link">2：springboot整合word</a></li><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/整合三方/3：springboot基于模板word导出.html" class="sidebar-link">3：springboot基于模板word导出</a></li><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/整合三方/4：springboot整合pdf.html" class="sidebar-link">4：springboot整合pdf</a></li><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/整合三方/5：springboot整合QQ邮箱.html" class="sidebar-link">5：springboot整合QQ邮箱</a></li><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/整合三方/6：springboot整合jasypt实现yml配置文件密码加密.html" class="sidebar-link">6：springboot整合jasypt实现yml配置文件密码加密</a></li><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/整合三方/7：springboot实现微信登录.html" class="sidebar-link">7：springboot实现微信登录</a></li><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/整合三方/8：springboot整合Redis.html" class="sidebar-link">8：springboot整合Redis</a></li><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/整合三方/9：springboot整合七牛云.html" class="sidebar-link">9：springboot整合七牛云</a></li><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/整合三方/10：springboot整合MybatisPlus.html" class="sidebar-link">10：springboot整合MybatisPlus</a></li><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/整合三方/11：springboot整合Swagger.html" class="sidebar-link">11：springboot整合Swagger</a></li><li><a href="/xiaoze-blog/blogs/工具/spring/springboot/整合三方/12：springboot整合微信推送.html" class="sidebar-link">12：springboot整合微信推送</a></li></ul></section></li></ul></section></li></ul></section></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>7：redis实现优惠券秒杀</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2023
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">7：redis实现优惠券秒杀</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>胡昊泽</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>12/8/2023</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>Redis</span><span class="tag-item" data-v-8a445198>springboot</span></i></div></div> <div class="theme-reco-content content__default"><p><strong>涉及</strong></p> <ul><li><code>Redis</code> 的计数器，<code>Lua</code> 脚本 <code>Redis</code></li> <li>分布式锁</li> <li><code>Redis</code> 的三种消息队列</li></ul> <h2 id="_1-全局id生成器"><a href="#_1-全局id生成器" class="header-anchor">#</a> 1：全局ID生成器</h2> <p><code>全局id生成器</code>，是一种在分布式系统下用俩 <code>生成全局唯一ID</code> 的工具，满足以下特性</p> <p><img src="/xiaoze-blog/assets/img/image11.8b49097e.png" alt="Alt text"></p> <p><img src="/xiaoze-blog/assets/img/image12.1531e116.png" alt="Alt text"></p> <p>ID生成器工具类代码，效率基本可以达到每秒1w个</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisIdWorker</span> <span class="token punctuation">{</span>
    <span class="token comment">//开始时间戳</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">BEGIN_TIMESTAMP</span> <span class="token operator">=</span> <span class="token number">1674086400L</span><span class="token punctuation">;</span>

    <span class="token comment">//序列号位数</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">COUNT_BITS</span> <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">RedisIdWorker</span><span class="token punctuation">(</span><span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>stringRedisTemplate <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">nextId</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyPrefix<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//1.生成时间戳</span>
        <span class="token class-name">LocalDateTime</span> time <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> nowSecond <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">toEpochSecond</span><span class="token punctuation">(</span><span class="token class-name">ZoneOffset</span><span class="token punctuation">.</span><span class="token constant">UTC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> timestamp <span class="token operator">=</span> nowSecond <span class="token operator">-</span> <span class="token constant">BEGIN_TIMESTAMP</span><span class="token punctuation">;</span>
        <span class="token comment">//2.生成序列号,redis自增长,redis单个key自增长有上限，2的64次方</span>
        <span class="token comment">//2.1获取当前日期，精确到天</span>
        <span class="token class-name">String</span> date <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy:MM:dd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> count <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token string">&quot;icr:&quot;</span> <span class="token operator">+</span> keyPrefix <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> date<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3.拼接并返回,不能使用字符串方式拼接</span>
        <span class="token keyword">return</span> timestamp <span class="token operator">&lt;&lt;</span> <span class="token constant">COUNT_BITS</span> <span class="token operator">|</span> count<span class="token punctuation">;</span><span class="token comment">//先向左移32位，那么低32位全为0，跟序列号进行或操作</span>

    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 生成开始时间戳
     * @param args
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">LocalDateTime</span> time <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">2023</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> second <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">toEpochSecond</span><span class="token punctuation">(</span><span class="token class-name">ZoneOffset</span><span class="token punctuation">.</span><span class="token constant">UTC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>second<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h2 id="_2-秒杀下单"><a href="#_2-秒杀下单" class="header-anchor">#</a> 2: 秒杀下单</h2> <p>下单业务本质上就是 <strong>修改优惠券表中的number字段</strong>，<strong>再在order表中新增一条订单数据</strong>；点击抢购优惠券，发送请求如下</p> <p><img src="/xiaoze-blog/assets/img/image13.6d084a5f.png" alt="Alt text"></p> <p><img src="/xiaoze-blog/assets/img/image14.088a66fc.png" alt="Alt text"></p> <p>以上是业务逻辑，其中涉及到的表操作</p> <ul><li><code>seckill_voucher</code> 表的根据id查询操作</li> <li><code>seckill_voucher</code> 表的根据id修改剩余数量的操作</li> <li><code>voucher_order</code> 表的新增订单数据操作</li></ul> <p>涉及到多表操作需要添加事务，同成功，同失败</p> <h2 id="_3-超卖问题"><a href="#_3-超卖问题" class="header-anchor">#</a> 3：超卖问题</h2> <p><img src="/xiaoze-blog/assets/img/image15.8f488da7.png" alt="Alt text"></p> <p>通过加锁的方式去处理多线程问题</p> <p><img src="/xiaoze-blog/assets/img/image16.d48d3115.png" alt="Alt text"></p> <h3 id="_1-悲观锁"><a href="#_1-悲观锁" class="header-anchor">#</a> 1）悲观锁</h3> <blockquote><p>悲观锁实现比较简单，操作前获取锁，操作结束才释放锁，让多个线程串行执行，但是你让并发线程串行，效率十分低下</p></blockquote> <h3 id="_2-乐观锁-版本号、cas"><a href="#_2-乐观锁-版本号、cas" class="header-anchor">#</a> 2）乐观锁（版本号、CAS）</h3> <blockquote><p>第一种加版本号的方式</p></blockquote> <p>逻辑如下：
<img src="/xiaoze-blog/assets/img/image17.a58d51aa.png" alt="Alt text"></p> <blockquote><p>第二种方式CAS法</p></blockquote> <p>用版本号方式，发现，用每次查的版本跟操作前查的版本作对比是否一致，那还不如直接查库存，用库存对比，更加简化，逻辑如下</p> <p><img src="/xiaoze-blog/assets/img/image18.fb1bb5d8.png" alt="Alt text"></p> <p>主要是在扣减操作上加上条件，查询的值不一致，就不执行操作</p> <p>在idea中，代码修改，在更新数据库操作，也就是减库存的时候，加上判断条件，eq比较</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//5.扣减库存</span>
    <span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;stock = stock - 1&quot;</span><span class="token punctuation">)</span><span class="token comment">//set stock = stock -1</span>
        <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">,</span>voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//where id = ? and stock =?</span>
        <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>如果是匹配库存，成功率很低，如下压力测试，100张只售出23张，但是我是开的有200个线程</p> <p><img src="/xiaoze-blog/assets/img/image19.bfb3b57f.png" alt="Alt text"></p> <p>成功率低的原因</p> <p><img src="/xiaoze-blog/assets/img/image20.375386e4.png" alt="Alt text"></p> <p>所以，我们更改库存操作时，加的条件不必是必须前面查到的库存数和更改时查到的库存数一致，我们只需要让更改时的条件为查到的库存数大于0即可，代码修改如下</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//5.扣减库存</span>
    <span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;stock = stock - 1&quot;</span><span class="token punctuation">)</span><span class="token comment">//set stock = stock -1</span>
        <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//where id = ? and stock &gt; 0 </span>
        <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="_4-一人一单"><a href="#_4-一人一单" class="header-anchor">#</a> 4：一人一单</h2> <p>业务逻辑修改，防止黄牛批量刷券</p> <p><img src="/xiaoze-blog/assets/img/image21.6f4e35ea.png" alt="Alt text"></p> <p>加锁方式，在并发请求时，保证一个用户只能下一单</p> <p><img src="/xiaoze-blog/assets/img/image22.fdcc2949.png" alt="Alt text"></p> <p>以下是最后结果图。这个一人一单的单体项目这一节，知识点太多了，像spring框架事务失效、aop代理对象、synchronized锁对象等等，这一节值得多看几遍，我自认为我是没有能力将这些知识点阐述的非常清晰的，所以直接多看这节视频，知识点我就不记录了，就算记录也是模糊不清不能像老师那么浅显易懂。
<img src="/xiaoze-blog/assets/img/image23.5e74a6e3.png" alt="Alt text"></p> <p><img src="/xiaoze-blog/assets/img/image24.b79a4984.png" alt="Alt text"></p> <p>通过 <code>加锁</code> 可以解决在 <code>单机情况</code> 下的一人一单安全问题，但是在 <code>集群模式</code> 下就不行了。</p> <p>我们将服务启动两份，端口分别为 <code>8081</code> 和 <code>8082</code>：ctrl+d复制启动类，添加端口配置</p> <p><img src="/xiaoze-blog/assets/img/image25.b09c15c3.png" alt="Alt text"> <img src="/xiaoze-blog/assets/img/image26.90af1b61.png" alt="Alt text"></p> <p>然后修改 <code>nginx</code> 的 <code>conf</code> 目录下的 <code>nginx.conf</code> 文件，配置反向代理；更改完毕后需要重新启动 <code>nginx</code> 服务</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>nginx.exe <span class="token parameter variable">-s</span> reload
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="/xiaoze-blog/assets/img/image27.e1abf87a.png" alt="Alt text"></p> <p>现在，用户请求会在这两个节点上负载均衡，再次测试下发现存在线程安全问题。</p> <p>但是在集群模式下，加锁只是 <code>该台jvm</code> 给当前这台服务器处理的请求加锁，而集群是多台服务器轮询处理请求，会造成每台服务器都有一个加锁的线程，每台服务器都会有一个新订单创建处理</p> <p><img src="/xiaoze-blog/assets/img/image28.18037999.png" alt="Alt text"></p> <h2 id="_5-分布式锁"><a href="#_5-分布式锁" class="header-anchor">#</a> 5：分布式锁</h2> <p><code>分布式锁</code> ：满足分布式系统或集群模式下多进程可见并且互斥的锁。</p> <p><img src="/xiaoze-blog/assets/img/image29.4714410a.png" alt="Alt text"></p> <p><code>分布式锁的特点</code> ：多进程可见、互斥、高可用、高性能（高并发）、安全性</p> <p>分布式锁的核心是实现多进程之间互斥，而满足这一点的方式有很多，常见的分布式锁有以下三种</p> <p><img src="/xiaoze-blog/assets/img/image30.7e1bd085.png" alt="Alt text"></p> <h3 id="_1-初级版本"><a href="#_1-初级版本" class="header-anchor">#</a> 1）初级版本</h3> <p>用redis实现分布式锁</p> <p><img src="/xiaoze-blog/assets/img/image31.fdb35190.png" alt="Alt text"></p> <div class="custom-block warning"><p class="title">原理</p><p><code>Redis分布式锁原理</code> ：基于 <code>setnx</code> 命令–&gt;key存在的情况下，不更新value，而是返回nil
那么利用key是唯一的特性来加锁，比如一人一单业务，key名称精确到userId，那么同一个用户无论发多少次请求，能成功创建键值的只有一个，因为setnx命令，后面的请求在获取锁创建键值就会失败</p></div><p>redis获取锁命令测试，设置过期时间为10秒的锁，nx–&gt;唯一</p> <p><img src="/xiaoze-blog/assets/img/image32.0dc45044.png" alt="Alt text"></p> <p>以下是结果图，两台机器发送请求，只有一台能够获取锁成功，这就是分布式锁的作用，它的作用域不再是单体项目，单机模式，而是在整个集群模式下，它的锁都生效。</p> <p><img src="/xiaoze-blog/assets/img/image33.fa588523.png" alt="Alt text"></p> <p><img src="/xiaoze-blog/assets/img/image34.1b70200d.png" alt="Alt text"></p> <p>Redis中存的也是唯一的键值</p> <p><img src="/xiaoze-blog/assets/img/image35.e463690e.png" alt="Alt text"></p> <p>数据库的表中数据变化</p> <p><img src="/xiaoze-blog/assets/img/image36.3375fa31.png" alt="Alt text"></p> <h3 id="_2-误删问题"><a href="#_2-误删问题" class="header-anchor">#</a> 2）误删问题</h3> <blockquote><p>场景描述
<img src="/xiaoze-blog/assets/img/image37.6dca8f49.png" alt="Alt text"></p></blockquote> <p>解决逻辑如下图</p> <p><img src="/xiaoze-blog/assets/img/image38.1df81fde.png" alt="Alt text"></p> <div class="custom-block warning"><p class="title">解释</p><p>其实就是在每次释放锁的时候进行判断，判断当前锁与自己是否一致，不一致可能是别人的锁，不释放</p></div><p>业务流程图</p> <p><img src="/xiaoze-blog/assets/img/image39.35056f55.png" alt="Alt text"></p> <h3 id="_3-原子性问题"><a href="#_3-原子性问题" class="header-anchor">#</a> 3）原子性问题</h3> <blockquote><p>场景描述</p></blockquote> <p><img src="/xiaoze-blog/assets/img/image40.81ce661e.png" alt="Alt text"></p> <div class="custom-block warning"><p class="title">解释</p><p>判断锁的操作和释放锁的操作得成一个原子性操作，一起执行，要阻塞都阻塞，要通过都通过</p></div><p><code>Redis</code> 提供了 <code>Lua</code> 脚本功能，在一个脚本中编写多条 <code>Redis</code> 命令，确保多条命令执行时的原子性。
Lua是一种编程语言，它的基本语法大家可以参考网站：<a href="https://www.runoob.com/lua/lua-tutorial.html" target="_blank" rel="noopener noreferrer">lua语言<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
我们将释放锁的操作写到Lua脚本中去，直接调用脚本</p> <blockquote><p>释放锁的业务逻辑是这样的：</p></blockquote> <ul><li>①获取锁中的线程标示</li> <li>②判断是否与指定的标示（当前线程标示）一致</li> <li>③如果一致则释放锁（删除）</li> <li>④如果不一致则什么都不做</li></ul> <p>Lua脚本代码</p> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code><span class="token comment">-- 这里的 KEYS[1] 就是锁的 key，这里的 ARGV[1] 就是当前线程标识</span>
<span class="token comment">-- 获取锁中的线程标识 get key</span>
<span class="token keyword">local</span> id <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 比较线程标识与锁中的标识是否一致</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
    <span class="token comment">-- 释放锁 del key</span>
    <span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'del'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token keyword">return</span> <span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_4-redisson分布式锁"><a href="#_4-redisson分布式锁" class="header-anchor">#</a> 4）Redisson分布式锁</h3> <blockquote><p>基于 setnx 实现的分布式锁存在下面的问题</p></blockquote> <ul><li><code>不可重入</code>：同一个线程无法多次获取同一把锁</li> <li><code>不可重试</code>：获取锁只尝试一次就返回 false，没有重试机制</li> <li><code>超时释放</code>：锁超时释放虽然可以避免死锁，但如果是业务执行耗时较长，也会导致锁释放，存在安全隐患</li> <li><code>主从一致性</code>：如果 Redis 提供了主从集群，主从延同步在延迟，当主机宕机时，如果从机同步主机中的数据，则会出现锁失效</li></ul> <p><code>Redisson</code> 是一个在 <code>Redis</code> 的基础上实现的 Java 驻内存数据网格
它不仅提供了一系列的分布式的 Java 常用对象，还提供了许多分布式服务，其中就包含了各种分布式锁的实现。</p> <p>说白了就是一个封装各种锁且十分完善的工具，前面又白雪了，分布式锁轮子人家已经做的很完善了，咱学的就是个思想  <a href="https://redisson.org" target="_blank" rel="noopener noreferrer">官网地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>要使用 <code>Redisson</code> ，先导入它的坐标</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.13.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>Redisson类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedissonClient</span> <span class="token function">redissionClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 配置类</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 添加 Redis 地址，此处添加了单点的地址，也可以使用 config.useClusterServers() 添加集群地址</span>
        config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">&quot;redis://192.168.2.12:6379&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;123321&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 创建客户端</span>
        <span class="token keyword">return</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>使用 <code>Redisson</code> 的分布式锁</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Resource</span>
<span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testRedisson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取锁（可重入），指定锁的名称</span>
    <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;anyLock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 尝试获取锁，参数分别是：获取锁的最大等待时间（期间会重试过），锁自动释放时间，时间单位</span>
    <span class="token keyword">boolean</span> isLock <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 判断锁是否获取成功</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;执行业务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">//释放锁</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><blockquote><p>Redisson 分布式锁原理</p></blockquote> <p><img src="/xiaoze-blog/assets/img/image41.482dc8dc.png" alt="Alt text"></p> <blockquote><p>连锁策略：不再有主从节点，都获取成功才能获取锁成功，有一个节点获取锁不成功就获取锁失败</p></blockquote> <p><img src="/xiaoze-blog/assets/img/image42.3f2f3b22.png" alt="Alt text"></p> <p style="color:red;">如果多个主节点保证锁的话，一个主节点宕机了，其它线程只能获得一个新主节点的锁，获取不到其它两个锁，还会获取失败，这里主要是防止主节点宕机后，其它线程获得新主节点的锁，引起线程安全问题</p> <blockquote><p>总结</p></blockquote> <ul><li><p>①<code>不可重入Redis 分布式锁</code></p> <ul><li><code>原理</code>：利用 setnx 的互斥性；利用 ex 避免死锁；释放锁时判断线程标示</li> <li><code>缺陷</code>：不可重入、无法重试、锁超时失效</li></ul></li> <li><p>②<code>可重入的 Redis 分布式锁</code></p> <ul><li><code>原理</code>：利用 hash 结构，记录线程标示和重入次数；利用 watchDog 延续锁时间；利用信号量控制锁重试等待</li> <li><code>缺陷</code>：Redis 宕机引起锁失效问题</li></ul></li> <li><p>③<code>Redisson 的 multiLock连锁</code></p> <ul><li><code>原理</code>：多个独立的 Redis 节点，必须在所有节点都获取重入锁，才算获取锁成功</li> <li><code>缺陷</code>：运维成本高、实现复杂</li></ul></li></ul> <h3 id="_5-秒杀优化"><a href="#_5-秒杀优化" class="header-anchor">#</a> 5）秒杀优化</h3> <p>流程图</p> <p><img src="/xiaoze-blog/assets/img/image43.505be6f5.png" alt="Alt text"></p> <p>为避免所有操作都在数据库上执行，分离成两个线程，<em><strong>一个线程判断用户的购买资格，发现用户有购买资格后再开启一个独立的线程来处理耗时较久的减库存、写订单的操作</strong></em> 。
可以将耗时较短的两步操作放到 Redis 中，在 Redis 中处理对应的秒杀资格的判断。Redis 的性能是比 MySQL 要好的。此外，还需要引入异步队列记录相关的信息。</p> <p><strong>redis部分处理逻辑， Lua脚本封装操作保证原子性， redis这里选择的存储类型为set，因为key不能重复，而set恰好是无序不重复的</strong></p> <p><img src="/xiaoze-blog/assets/img/image44.6e3ba257.png" alt="Alt text"></p> <p><em><strong>案例：改进秒杀业务，提高并发性能</strong></em></p> <blockquote><p>需求：</p></blockquote> <ul><li>1.新增秒杀优惠券的同时，将优惠券信息保存到 Redis 中</li> <li>2.基于 Lua 脚本，判断秒杀库存、一人一单，决定用户是否抢购成功</li> <li>3.如果抢购成功，将优惠券 id 和用户 id 封装后存入阻塞队列</li> <li>4.开启线程任务，不断从阻塞队列中获取信息，实现异步下单功能</li></ul> <p><strong>分步实现如下</strong></p> <p>1.在新增优惠券的业务实现类中，把秒杀优惠券的库存信息保存到redis里</p> <p><code>VoucherServiceImpl</code> 类中</p> <p><img src="/xiaoze-blog/assets/img/image45.f406e8e7.png" alt="Alt text"></p> <p>2.编写lua脚本，按照下面的业务流程逻辑，在脚本中完成业务实现</p> <p><img src="/xiaoze-blog/assets/img/image46.7b385929.png" alt="Alt text"></p> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code><span class="token comment">-- 1.参数列表</span>
<span class="token comment">-- 1.1 优惠券id</span>
<span class="token keyword">local</span> voucherId <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token comment">-- 1.2 用户id</span>
<span class="token keyword">local</span> userId <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>

<span class="token comment">-- 2.数据key</span>
<span class="token comment">-- 2.1 库存key   key 是优惠的业务名称加优惠券id  value 是优惠券的库存数</span>
<span class="token keyword">local</span> stockKey <span class="token operator">=</span> <span class="token string">'seckill:stock:'</span> <span class="token operator">..</span> voucherId
<span class="token comment">-- 2.2 订单key   key 也是拼接的业务名称加优惠权id  而value是用户id， 这是一个set集合，凡购买该优惠券的用户都会将其id存入集合中</span>
<span class="token keyword">local</span> orderKey <span class="token operator">=</span> <span class="token string">'seckill:order:'</span> <span class="token operator">..</span> voucherId

<span class="token comment">-- 3.脚本业务</span>
<span class="token comment">-- 3.1 判断库存是否充足 get stockKey</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tonumber</span><span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> stockKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token keyword">then</span>  <span class="token comment">--将get的value先转为数字类型才能判断比较</span>
    <span class="token comment">-- 3.2 库存不足，返回1</span>
    <span class="token keyword">return</span> <span class="token number">1</span>
<span class="token keyword">end</span>
<span class="token comment">-- 3.3 判断用户是否下单 sismember orderKey userId命令，判断当前key集合中，是否存在该value；返回1存在，0不存在</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'sismember'</span><span class="token punctuation">,</span> orderKey<span class="token punctuation">,</span> userId<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
    <span class="token comment">--3.4 存在说明是重复下单，返回2</span>
    <span class="token keyword">return</span> <span class="token number">2</span>
<span class="token keyword">end</span>
<span class="token comment">-- 3.5 扣库存</span>
redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'incrby'</span><span class="token punctuation">,</span> stockKey<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">-- 3.6 下单（保存用户）</span>
redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'sadd'</span><span class="token punctuation">,</span> orderKey<span class="token punctuation">,</span> userId<span class="token punctuation">)</span>
<span class="token keyword">return</span> <span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>3.java代码中执行lua脚本，并判断，抢购成功的生成订单并存入阻塞队列</p> <p>首先注入脚本</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token class-name">IVoucherOrderService</span> proxy<span class="token punctuation">;</span><span class="token comment">//定义代理对象，提前定义后面会用到</span>
    <span class="token comment">//注入脚本</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token constant">SECKILL_SCRIPT</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token constant">SECKILL_SCRIPT</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">SECKILL_SCRIPT</span><span class="token punctuation">.</span><span class="token function">setLocation</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">&quot;seckill.lua&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">SECKILL_SCRIPT</span><span class="token punctuation">.</span><span class="token function">setResultType</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>其次运行脚本，且判断不满足的请求直接返回提示信息</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//使用lua脚本</span>
        <span class="token comment">//获取用户</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//1.执行lua脚本</span>
        <span class="token class-name">Long</span> result <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>
                <span class="token constant">SECKILL_SCRIPT</span><span class="token punctuation">,</span>
                <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//这里是key数组，没有key，就传的一个空集合</span>
                voucherId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2.判断结果是0</span>
        <span class="token keyword">int</span> r <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Long型转为int型，便于下面比较</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//2.1 不为0，代表没有购买资格</span>
            <span class="token keyword">return</span>  <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token number">1</span><span class="token operator">?</span><span class="token string">&quot;优惠券已售罄&quot;</span><span class="token operator">:</span><span class="token string">&quot;不能重复购买&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>最后是将满足条件的给存放进阻塞队列中</p> <p>创建一个<code>BlockingQueue</code> 阻塞队列</p> <blockquote><p><code>BlockingQueue</code> 这个阻塞队列特点：当一个线程尝试从队列获取元素的时候，如果没有元素该线程阻塞，直到队列中有元素才会被唤醒并获取元素</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//创建阻塞队列  这个阻塞队列特点：当一个线程尝试从队列获取元素的时候，如果没有元素该线程阻塞，直到队列中有元素才会被唤醒获取</span>
    <span class="token keyword">private</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VoucherOrder</span><span class="token punctuation">&gt;</span></span> orderTasks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化阻塞队列的大小</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>接下来就是将满足条件的请求，给生成订单，并把订单对象add到阻塞队列中，接上面的代码，完成整个第三步</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>        <span class="token comment">//2.2 为0，有购买资格，把下单信息保存到阻塞队列中</span>
        <span class="token comment">//7.创建订单   向订单表新增一条数据，除默认字段，其他字段的值需要set</span>
        <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//7.1订单id</span>
        <span class="token keyword">long</span> orderId <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//7.2用户id</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//7.3代金券id</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//放入阻塞对列中</span>
        orderTasks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取代理对象</span>
        proxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IVoucherOrderService</span><span class="token punctuation">)</span> <span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">currentProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3.返回订单id</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>4.开启线程任务，实现异步下单功能</p> <ul><li><p>首先创建一个线程池</p></li> <li><p>再定义一个线程任务，但是注意，线程任务需要在用户秒杀订单之前开始，用户一但开始秒杀，队列就会有新的订单，线程任务就应该立即取出订单信息，这里利用spring提供的注解，在类初始化完毕后立即执行线程任务，详细代码如下</p></li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//创建线程池</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ExecutorService</span> <span class="token constant">SECKILL_ORDER_EXECUTOR</span> <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//利用spring提供的注解，在类初始化完毕后立即执行线程任务</span>
    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token constant">SECKILL_ORDER_EXECUTOR</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">VoucherOrderHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>线程任务代码如下</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//创建线程任务，内部类方式</span>
    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">VoucherOrderHandler</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//1.获取队列中的订单信息</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> orderTasks<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//2.创建订单，这是调之前那个创建订单的方法，需要稍作改动</span>
                <span class="token function">handleVoucherOrder</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;异常信息:&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>创建调用的 <code>handleVoucherOrder</code> 方法，这里的获取锁操作只是做最后的兜底，以防万一，因为前面lua脚本都已经判断过了</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleVoucherOrder</span><span class="token punctuation">(</span><span class="token class-name">VoucherOrder</span> voucherOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> voucherOrder<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//创建锁对象</span>
        <span class="token class-name">SimpleRedisLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleRedisLock</span><span class="token punctuation">(</span><span class="token string">&quot;order:&quot;</span> <span class="token operator">+</span> userId<span class="token punctuation">,</span> stringRedisTemplate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取锁</span>
        <span class="token keyword">boolean</span> isLock <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">1200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//判断是否获取锁成功</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isLock<span class="token punctuation">)</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;您已购买过该商品，不能重复购买&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            proxy<span class="token punctuation">.</span><span class="token function">createVoucherOrder</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//使用代理对象，最后用于提交事务</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalStateException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//释放锁</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><code>createVoucherOrder</code> 创建订单方法，这里一人一单的其实也不必判读了，lua脚本都写好了，这里只是兜底</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code> <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createVoucherOrder</span><span class="token punctuation">(</span><span class="token class-name">VoucherOrder</span> voucherOrder<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Long</span> voucherId <span class="token operator">=</span> voucherOrder<span class="token punctuation">.</span><span class="token function">getVoucherId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//5.一人一单</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> voucherOrder<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//5.1查询订单</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//5.2判断是否存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;您已经购买过了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//6.扣减库存</span>
        <span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;stock = stock - 1&quot;</span><span class="token punctuation">)</span><span class="token comment">//set stock = stock -1</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//where id = ? and stock &gt; 0</span>
                <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;库存不足！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><strong>最后来分析以下整个优化思路</strong></p> <ul><li><p>① <code>编写lua脚本</code> ，对于超卖问题和一人一单进行解决处理，超卖用 <code>CAS</code> 方法判断库存是否大于0，一人一单用 <code>redis</code> 的 <code>set</code> 集合的 <code>sismenber</code> 判读该优惠券（key）下的用户id（value）是否唯一</p></li> <li><p>②Java代码中注入脚本，并执行脚本判断脚本返回结果，若不为脚本结果0，直接返回错误提示</p></li> <li><p>③若脚本结果为0，代表有购买优惠券资格，将 <code>new VoucherOrder</code> 创建订单对象，并 <code>set orderId，userId，voucherId</code>。再把订单对象放入 <code>阻塞队列</code> 中，返回 <code>订单id</code> 给用户</p></li> <li><p>④创建线程池，并定义线程任务，但注意，线程任务必须在方法执行前执行，使用到spring提供的注解在类初始化完成后执行线程任务</p></li> <li><p>⑤线程任务中获取阻塞队列的订单对象，然后调用 <code>handleVoucherOrder</code> 方法传入 <code>voucherOrder</code></p></li> <li><p>⑥ <code>handleVoucherOrder</code> 方法其实是再次获取锁，这个就是个纯兜底，作用不大。并在获取锁成功后调用 <code>createVoucherOrder</code> 方法扣减库存创建订单，由于都是对数据库的操作，因此要提交事务</p></li></ul> <p>至此，整个秒杀业务优化完毕</p> <blockquote><p>总结</p></blockquote> <blockquote><p>秒杀业务的优化思路是什么？</p></blockquote> <ul><li>先利用 Redis 完成库存余量、一人一单判断，完成抢单业务</li> <li>再将下单业务放入阻塞队列，利用独立线程异步下单</li></ul> <blockquote><p>基于阻塞队列的异步秒杀存在哪些问题？
内存限制问题 —&gt; 我们使用的是JDK里的阻塞队列，是基于JVM的内存，高并发海量请求下造成内存溢出还有服务宕机情况下内存数据丢失</p></blockquote> <blockquote><p>数据安全问题</p></blockquote> <blockquote><p>个人认为还存在的问题</p></blockquote> <ul><li>队列满了怎么办 ？</li> <li>子线程下单失败怎么办？</li> <li>订单太多了超过阻塞队列大小了怎么办？</li> <li>拒绝策略怎么设计？</li> <li>待消费的消息是否应该持久化，不然宕机了消息不就丢失了？</li> <li>还有如何确保消息确实被消费成功了，不然消费失败了无法重试</li></ul> <h3 id="_6-消息队列"><a href="#_6-消息队列" class="header-anchor">#</a> 6）消息队列</h3> <p>由于前面的阻塞队列是基于JVM的内存实现，那么不可避免的两个大问题，</p> <ul><li>①高并发海量访问，创建订单，队列很快就 <strong>超出上限造成内存溢出</strong>；</li> <li>②JVM内存没有持久化机制，若服务出现重启或宕机，阻塞队列中的所有任务都会丢失。所以我们使用MQ</li></ul> <p><img src="/xiaoze-blog/assets/img/image47.5291996d.png" alt="Alt text"></p> <p>MQ是JVM以外的服务，不受JVM内存限制，且MQ中的所有消息会做持久化，这样即使重启或宕机，数据不会丢失。消息投递给消费者后需要消费者确认，未确认消息会一直存在下一次继续投递，确保消息至少被消费一次</p> <h4 id="基于-list-结构模拟消息队列"><a href="#基于-list-结构模拟消息队列" class="header-anchor">#</a> 基于 List 结构模拟消息队列</h4> <p><code>Redis</code> 的 <code>list</code> 数据结构是一个双向链表
队列是入口和出口不在一边，因此我们可以利用：<code>LPUSH</code> 结合 <code>RPOP</code>、或者 <code>RPUSH</code> 结合 <code>LPOP</code> 来实现。</p> <p>不过要注意的是，当队列中没有消息时 <code>RPOP</code> 或 <code>LPOP</code> 操作会返回 <code>null</code>，并不像 <code>JVM</code> 的阻塞队列那样会阻塞并等待消息。</p> <p>因此这里应该使用 <code>BRPOP</code> 或者 <code>BLPOP</code> 来实现阻塞效果。</p> <p><img src="/xiaoze-blog/assets/img/image48.6cb5075c.png" alt="Alt text"></p> <blockquote><p>基于 List 的消息队列有哪些优缺点</p></blockquote> <ul><li>优点
<ul><li>利用 <code>Redis</code> 存储，不受限于 <code>JVM</code> 内存上限</li> <li>基于 <code>Redis</code> 的持久化机制，数据安全性有保证</li> <li>可以满足消息有序性</li></ul></li> <li>缺点
<ul><li>无法避免消息丢失</li> <li>只支持单消费者</li></ul></li></ul> <h4 id="基于-pubsub-的消息队列"><a href="#基于-pubsub-的消息队列" class="header-anchor">#</a> 基于 PubSub 的消息队列</h4> <p>PubSub（发布订阅） 是 Redis 2.0 版本引入的消息传递模型。</p> <p>顾名思义，消费者可以订阅一个或多个channel，生产者向对应 channel 发送消息后，所有订阅者都能收到相关消息。</p> <ul><li><code>SUBSCRIBE channel [channel]</code> ：订阅一个或多个频道</li> <li><code>PUBLISH channel msg</code> ：向一个频道发送消息</li> <li><code>PSUBSCRIBE pattern[pattern]</code> ：订阅与 pattern 格式匹配的所有频道</li></ul> <p><code>pattern</code> – 通配符方式</p> <ul><li>?：匹配一个字符</li> <li>*：匹配多个字符</li> <li>ae：匹配括号内存在的字符</li></ul> <p><img src="/xiaoze-blog/assets/img/image49.e3e4931e.png" alt="Alt text"></p> <blockquote><p>基于 PubSub 的消息队列有哪些优缺点</p></blockquote> <ul><li>优点：采用发布订阅模型，支持多生产、多消费</li> <li>缺点：
<ul><li>不支持数据持久化</li> <li>无法避免消息丢失</li> <li>消息堆积有上限，超出时数据丢失</li></ul></li></ul> <h4 id="基于-stream-的消息队列"><a href="#基于-stream-的消息队列" class="header-anchor">#</a> 基于 Stream 的消息队列</h4> <blockquote><p>单消费模式</p></blockquote> <p><strong>发送消息的命令</strong></p> <p><img src="/xiaoze-blog/assets/img/image50.743ebbc8.png" alt="Alt text"></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>XADD key <span class="token punctuation">[</span>NOMKSTREAM<span class="token punctuation">]</span> <span class="token punctuation">[</span>MAXLEN<span class="token operator">|</span>MINID <span class="token punctuation">[</span><span class="token operator">=</span><span class="token operator">|</span>~<span class="token punctuation">]</span> threshold <span class="token punctuation">[</span>LIMIT count<span class="token punctuation">]</span><span class="token punctuation">]</span> *<span class="token operator">|</span>ID field value <span class="token punctuation">[</span>field value …<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li><p><code>key</code>：队列名称</p></li> <li><p><code>[NOMKSTREAM]</code>：如果队列不存在时，确定是否自动创建队列，默认自动创建</p></li> <li><p><code>[MAXLEN|MINID [=|~] threshold [LIMIT count]]</code>：设置消息队列的最大消息数量</p></li> <li><p><code>|ID</code>：消息的唯一 ID， 代表由 Redis 自动生成，格式是 ”时间戳-递增数字“，例如：”1666161469358-0“</p></li> <li><p><code>field value [field value …]</code>：发送到队列中的消息，称为 Entry。格式为多个 Key-Value 键值对。</p></li></ul> <blockquote><p>例如：创建名为 users 的队列，并向其中发送一个消息，内容是：{name=jack,age=21}，并且使用 Redis 自动生成 ID</p></blockquote> <p><code>127.0.0.1:6379&gt; XADD users * name jack age 21 “1644805700523-0”</code></p> <p><strong>读取消息命令</strong></p> <p><img src="/xiaoze-blog/assets/img/image51.aa7fbb31.png" alt="Alt text"></p> <p>读取消息的方式之一：<code>XREAD</code></p> <ul><li><code>[COUNT count]</code>：每次读取消息的最大数量；</li> <li><code>[BLOCK milliseconds]</code>：当没有消息时，确定是否阻塞，阻塞则添加具体的 milliseconds （阻塞时长）</li> <li><code>STREAMS key [key …]</code>：从哪个队列读取消息，Key 就是队列名；</li> <li><code>ID [ID …]</code>：起始 ID，只返回大于该 ID 的消息；0 代表从第一个消息开始，$ 代表从最新的消息开始。</li></ul> <blockquote><p>例如，使用 <code>XREAD</code> 读取第一个消息</p></blockquote> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> XREAD COUNT <span class="token number">1</span> STREAMS <span class="token function">users</span> <span class="token number">0</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;queue&quot;</span>
   <span class="token number">2</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;1666169070359-0&quot;</span>
         <span class="token number">2</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;name&quot;</span>
            <span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;jack&quot;</span>
            <span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">&quot;age&quot;</span>
            <span class="token number">4</span><span class="token punctuation">)</span> <span class="token number">20</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><code>XREAD</code> 阻塞方式，读取最新的消息</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>XREAD COUNT <span class="token number">1</span> BLOCK STREAMS queue $
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>注意</strong>：</p> <ul><li>当我们指定起始 ID 为 $ <code>时，代表读取最新的消息</code></li> <li>如果我们处理一条消息的过程中，又有超过 1 条以上的消息到达队列，则下次获取时也只能获取到最新的一条</li> <li>如此便会出现漏读消息的问题</li></ul> <p><strong>STREAM 类型消息队列的 XREAD 命令特点</strong>：</p> <ul><li>1.消息可回溯（消息永久的保存在消息队列中）</li> <li>2.一个消息可以被多个消费者读取</li> <li>3.可以阻塞读取</li> <li>4.有消息漏读的风险（缺点）</li></ul> <blockquote><p>消费者组模式</p></blockquote> <p><code>消费者组（Consumer Group）</code>：将多个消费者划分到一个组中，监听同一个队列。</p> <blockquote><p>其具备下列特点：</p></blockquote> <ul><li><code>消息分流</code>：队列中的 消息会分流给组内不同的消费者，而不是重复消费，从而加快消息处理的速度。</li> <li><code>消息标示</code>：消费者组会维护一个标示，记录最后一个被处理的消息，即使消费者宕机重启，还会从标示之后读取消息，确保每一个消息都会被消费。（解决漏读问题）</li> <li><code>消息确认</code>：消费者获取消息后，消息处于 pending 状态，并存入一个 pending-list。</li></ul> <p>当处理完成后需要通过 <code>XACK</code> 命令来确认消息，标记消息为已处理，才会从 pending-list 中移除。（解决消息丢失问题)</p> <p><strong>创建消费者组</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>XGROUP CREATE key groupName ID <span class="token punctuation">[</span>MKSTREAM<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li><code>key</code>：队列名称</li> <li><code>groupName</code>：消费者组名称</li> <li><code>ID</code>：起始 ID 标示，$ 代表队列中最后一个消息，0 则代表队列中第一个消息</li> <li><code>MKSTREAM</code>：队列不存在时自动创建队列</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 删除指定的消费者组</span>
XGROUP DESTORY key groupName

<span class="token comment"># 给指定的消费者组添加消费者</span>
XGROUP CREATECONSUMER key groupname consumername

<span class="token comment"># 删除消费者组中的指定消费者</span>
XGROUP DELCONSUMER key groupname consumername

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>从消费者组读取消息</strong></p> <blockquote><p>XREADGROUP GROUP group consumer [COUNT count] [BLOCK milliseconds] [NOACK] STREAMS key [key …] ID [ID …]</p></blockquote> <ul><li><code>group</code>：消费组名称</li> <li><code>consumer</code>：消费者名称，如果消费者不存在，会自动创建一个消费者</li> <li><code>count</code>：本次查询的最大数量</li> <li><code>BLOCK milliseconds</code>：当没有消息时最长等待时间</li> <li><code>NOACK</code>：无需手动 ACK，获取到消息后自动确认</li> <li><code>STREAMS key</code>：指定队列名称</li> <li><code>ID</code>：获取消息的起始 ID：</li> <li><code>“&gt;”</code>：从下一个未消费的消息开始</li> <li><code>其它</code>：根据指定 id 从 <code>pending-list</code> 中获取已消费但未确认的消息。</li></ul> <blockquote><p>STREAM 类型消息队列的 XREADGROUP 命令特点</p></blockquote> <ul><li>消息可回溯</li> <li>可以多消费者争抢消息，加快消费速度</li> <li>可以阻塞读取</li> <li>没有消息漏读的风险</li> <li>有消息确认机制，保证消息至少被消费一次</li></ul> <p><img src="/xiaoze-blog/assets/img/image52.18f83fee.png" alt="Alt text"></p> <blockquote><p>Stream消息队列异步秒杀下单</p></blockquote> <blockquote><p>需求：</p></blockquote> <ul><li>①创建一个 <code>Stream</code> 类型的消息队列，名为 <code>stream.orders</code></li> <li>②修改之前的秒杀下单 <code>Lua</code> 脚本，在认定有抢购资格后，直接向 <code>stream.orders</code> 中添加消息，内容包含 <code>voucherId</code>、<code>userId</code>、<code>orderId</code></li> <li>③项目启动时，开启一个线程任务，尝试获取 <code>stream.orders</code> 中的消息，完成下单</li></ul> <p>redis客户端命令行执行如下命令，创建消息队列</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>XGROUP CREATE stream.orders g1 <span class="token number">0</span> MKSTREAM
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Lua脚本改动</p> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code><span class="token comment">-- 1.参数列表</span>
<span class="token comment">-- 1.1.优惠券 id</span>
<span class="token keyword">local</span> voucherId <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token comment">-- 1.2.用户 id</span>
<span class="token keyword">local</span> userId <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
<span class="token comment">-- 1.3.订单 id</span>
<span class="token keyword">local</span> orderId <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>

<span class="token comment">-- 2.数据 key</span>
<span class="token comment">-- 2.1.库存 key</span>
<span class="token keyword">local</span> stockKey <span class="token operator">=</span> <span class="token string">'seckill:stock:'</span> <span class="token operator">..</span> voucherId
<span class="token comment">-- 2.2.订单 key</span>
<span class="token keyword">local</span> orderKey <span class="token operator">=</span> <span class="token string">'seckill:order:'</span> <span class="token operator">..</span> voucherId

<span class="token keyword">local</span> stockKey_value <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> stockKey<span class="token punctuation">)</span>

<span class="token comment">-- 3.脚本业务</span>
<span class="token comment">-- 3.1.判断库存是否充足 get stockKey</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tonumber</span><span class="token punctuation">(</span>stockKey_value<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
    <span class="token comment">-- 3.2.库存不足，返回 1</span>
    <span class="token keyword">return</span> <span class="token number">1</span>
<span class="token keyword">end</span>
<span class="token comment">-- 3.2.判断用户是否下单 SISMEMBER orderKey userId</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'sismember'</span><span class="token punctuation">,</span> orderKey<span class="token punctuation">,</span> userId<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
    <span class="token comment">-- 3.3.存在，则说明该用户是重复下单（这是不允许的），则返回 2</span>
    <span class="token keyword">return</span> <span class="token number">2</span>
<span class="token keyword">end</span>
<span class="token comment">-- 3.4.扣库存 incrby stockKey -1</span>
redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'incrby'</span><span class="token punctuation">,</span> stockKey<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">-- 3.5.下单（保存用户） sadd orderKey userId</span>
redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'sadd'</span><span class="token punctuation">,</span> orderKey<span class="token punctuation">,</span> userId<span class="token punctuation">)</span>
<span class="token comment">-- 3.6.发送消息到队列中：XADD stream.orders * k1 v1 k2 v2 ...</span>
redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'xadd'</span><span class="token punctuation">,</span> <span class="token string">'stream.orders'</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token string">'userId'</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token string">'voucherId'</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">,</span> <span class="token string">'id'</span><span class="token punctuation">,</span> orderId<span class="token punctuation">)</span>

<span class="token keyword">return</span> <span class="token number">0</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/xiaoze-blog/blogs/工具/redis/redis业务类/6：redis实现用户签到以及签到统计.html" class="prev">
          6：redis实现用户签到以及签到统计
        </a></span> <span class="next"><a href="/xiaoze-blog/blogs/工具/spring/springboot/开发必备/1：maven包大全.html">
          1：maven包大全
        </a></span></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/xiaoze-blog/blogs/%E5%B7%A5%E5%85%B7/redis/redis%E4%B8%9A%E5%8A%A1%E7%B1%BB/7%EF%BC%9Aredis%E5%AE%9E%E7%8E%B0%E4%BC%98%E6%83%A0%E5%88%B8%E7%A7%92%E6%9D%80.html#_1-全局id生成器" class="sidebar-link reco-side-_1-全局id生成器" data-v-b57cc07c>1：全局ID生成器</a></li><li class="level-2" data-v-b57cc07c><a href="/xiaoze-blog/blogs/%E5%B7%A5%E5%85%B7/redis/redis%E4%B8%9A%E5%8A%A1%E7%B1%BB/7%EF%BC%9Aredis%E5%AE%9E%E7%8E%B0%E4%BC%98%E6%83%A0%E5%88%B8%E7%A7%92%E6%9D%80.html#_2-秒杀下单" class="sidebar-link reco-side-_2-秒杀下单" data-v-b57cc07c>2: 秒杀下单</a></li><li class="level-2" data-v-b57cc07c><a href="/xiaoze-blog/blogs/%E5%B7%A5%E5%85%B7/redis/redis%E4%B8%9A%E5%8A%A1%E7%B1%BB/7%EF%BC%9Aredis%E5%AE%9E%E7%8E%B0%E4%BC%98%E6%83%A0%E5%88%B8%E7%A7%92%E6%9D%80.html#_3-超卖问题" class="sidebar-link reco-side-_3-超卖问题" data-v-b57cc07c>3：超卖问题</a></li><li class="level-3" data-v-b57cc07c><a href="/xiaoze-blog/blogs/%E5%B7%A5%E5%85%B7/redis/redis%E4%B8%9A%E5%8A%A1%E7%B1%BB/7%EF%BC%9Aredis%E5%AE%9E%E7%8E%B0%E4%BC%98%E6%83%A0%E5%88%B8%E7%A7%92%E6%9D%80.html#_1-悲观锁" class="sidebar-link reco-side-_1-悲观锁" data-v-b57cc07c>1）悲观锁</a></li><li class="level-3" data-v-b57cc07c><a href="/xiaoze-blog/blogs/%E5%B7%A5%E5%85%B7/redis/redis%E4%B8%9A%E5%8A%A1%E7%B1%BB/7%EF%BC%9Aredis%E5%AE%9E%E7%8E%B0%E4%BC%98%E6%83%A0%E5%88%B8%E7%A7%92%E6%9D%80.html#_2-乐观锁-版本号、cas" class="sidebar-link reco-side-_2-乐观锁-版本号、cas" data-v-b57cc07c>2）乐观锁（版本号、CAS）</a></li><li class="level-2" data-v-b57cc07c><a href="/xiaoze-blog/blogs/%E5%B7%A5%E5%85%B7/redis/redis%E4%B8%9A%E5%8A%A1%E7%B1%BB/7%EF%BC%9Aredis%E5%AE%9E%E7%8E%B0%E4%BC%98%E6%83%A0%E5%88%B8%E7%A7%92%E6%9D%80.html#_4-一人一单" class="sidebar-link reco-side-_4-一人一单" data-v-b57cc07c>4：一人一单</a></li><li class="level-2" data-v-b57cc07c><a href="/xiaoze-blog/blogs/%E5%B7%A5%E5%85%B7/redis/redis%E4%B8%9A%E5%8A%A1%E7%B1%BB/7%EF%BC%9Aredis%E5%AE%9E%E7%8E%B0%E4%BC%98%E6%83%A0%E5%88%B8%E7%A7%92%E6%9D%80.html#_5-分布式锁" class="sidebar-link reco-side-_5-分布式锁" data-v-b57cc07c>5：分布式锁</a></li><li class="level-3" data-v-b57cc07c><a href="/xiaoze-blog/blogs/%E5%B7%A5%E5%85%B7/redis/redis%E4%B8%9A%E5%8A%A1%E7%B1%BB/7%EF%BC%9Aredis%E5%AE%9E%E7%8E%B0%E4%BC%98%E6%83%A0%E5%88%B8%E7%A7%92%E6%9D%80.html#_1-初级版本" class="sidebar-link reco-side-_1-初级版本" data-v-b57cc07c>1）初级版本</a></li><li class="level-3" data-v-b57cc07c><a href="/xiaoze-blog/blogs/%E5%B7%A5%E5%85%B7/redis/redis%E4%B8%9A%E5%8A%A1%E7%B1%BB/7%EF%BC%9Aredis%E5%AE%9E%E7%8E%B0%E4%BC%98%E6%83%A0%E5%88%B8%E7%A7%92%E6%9D%80.html#_2-误删问题" class="sidebar-link reco-side-_2-误删问题" data-v-b57cc07c>2）误删问题</a></li><li class="level-3" data-v-b57cc07c><a href="/xiaoze-blog/blogs/%E5%B7%A5%E5%85%B7/redis/redis%E4%B8%9A%E5%8A%A1%E7%B1%BB/7%EF%BC%9Aredis%E5%AE%9E%E7%8E%B0%E4%BC%98%E6%83%A0%E5%88%B8%E7%A7%92%E6%9D%80.html#_3-原子性问题" class="sidebar-link reco-side-_3-原子性问题" data-v-b57cc07c>3）原子性问题</a></li><li class="level-3" data-v-b57cc07c><a href="/xiaoze-blog/blogs/%E5%B7%A5%E5%85%B7/redis/redis%E4%B8%9A%E5%8A%A1%E7%B1%BB/7%EF%BC%9Aredis%E5%AE%9E%E7%8E%B0%E4%BC%98%E6%83%A0%E5%88%B8%E7%A7%92%E6%9D%80.html#_4-redisson分布式锁" class="sidebar-link reco-side-_4-redisson分布式锁" data-v-b57cc07c>4）Redisson分布式锁</a></li><li class="level-3" data-v-b57cc07c><a href="/xiaoze-blog/blogs/%E5%B7%A5%E5%85%B7/redis/redis%E4%B8%9A%E5%8A%A1%E7%B1%BB/7%EF%BC%9Aredis%E5%AE%9E%E7%8E%B0%E4%BC%98%E6%83%A0%E5%88%B8%E7%A7%92%E6%9D%80.html#_5-秒杀优化" class="sidebar-link reco-side-_5-秒杀优化" data-v-b57cc07c>5）秒杀优化</a></li><li class="level-3" data-v-b57cc07c><a href="/xiaoze-blog/blogs/%E5%B7%A5%E5%85%B7/redis/redis%E4%B8%9A%E5%8A%A1%E7%B1%BB/7%EF%BC%9Aredis%E5%AE%9E%E7%8E%B0%E4%BC%98%E6%83%A0%E5%88%B8%E7%A7%92%E6%9D%80.html#_6-消息队列" class="sidebar-link reco-side-_6-消息队列" data-v-b57cc07c>6）消息队列</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><canvas id="vuepress-canvas-cursor"></canvas><div></div><div class="kanbanniang" data-v-5775ee02><div class="banniang-container" style="display:;" data-v-5775ee02><div class="messageBox" style="right:68px;bottom:190px;display:none;" data-v-5775ee02>
      欢迎来到 小泽认真奋进
    </div> <div class="operation" style="right:90px;bottom:40px;display:;" data-v-5775ee02><i class="kbnfont kbn-ban-home ban-home" data-v-5775ee02></i> <i class="kbnfont kbn-ban-message message" data-v-5775ee02></i> <i class="kbnfont kbn-ban-close close" data-v-5775ee02></i> <a target="_blank" href="https://vuepress-theme-reco.recoluan.com/views/plugins/kanbanniang.html" data-v-5775ee02><i class="kbnfont kbn-ban-info info" data-v-5775ee02></i></a> <i class="kbnfont kbn-ban-theme skin" style="display:;" data-v-5775ee02></i></div> <canvas id="banniang" width="150" height="220" class="live2d" style="right:90px;bottom:-20px;opacity:0.9;" data-v-5775ee02></canvas></div> <div class="showBanNiang" style="display:none;" data-v-5775ee02>
    看板娘
  </div></div><div class="Sakura" data-v-248d85d6><canvas id="canvas_sakura" style="z-index:999;" data-v-248d85d6></canvas></div></div></div>
    <script src="/xiaoze-blog/assets/js/app.eba831d4.js" defer></script><script src="/xiaoze-blog/assets/js/10.e507b461.js" defer></script><script src="/xiaoze-blog/assets/js/1.faeb34d2.js" defer></script><script src="/xiaoze-blog/assets/js/6.7b12d30e.js" defer></script>
  </body>
</html>
