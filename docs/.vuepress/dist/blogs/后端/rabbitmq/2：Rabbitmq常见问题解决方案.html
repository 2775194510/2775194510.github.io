<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>2：Rabbitmq常见问题解决方案 | 小泽认真奋进</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/xiaoze-blog/assets/css/0.styles.25451b68.css" as="style"><link rel="preload" href="/xiaoze-blog/assets/js/app.acca6ad0.js" as="script"><link rel="preload" href="/xiaoze-blog/assets/js/11.29fd6443.js" as="script"><link rel="preload" href="/xiaoze-blog/assets/js/1.53f89df5.js" as="script"><link rel="preload" href="/xiaoze-blog/assets/js/31.a3e8b87d.js" as="script"><link rel="prefetch" href="/xiaoze-blog/assets/js/10.c67f105c.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/100.46f5ff6c.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/101.96581831.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/102.c4372794.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/103.75a4c6d3.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/104.1ad5524f.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/105.9328ccd4.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/106.ce5ac45c.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/107.494cd68d.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/108.ceb3456c.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/109.5b8601ba.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/110.082b9d59.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/111.b2f2ebef.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/112.34c47703.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/113.10a07c84.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/114.e9a2e3cd.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/115.f1fa8898.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/116.374edc35.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/117.fd58662c.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/118.bdb8b005.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/119.9e0b16bc.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/12.d49d87e8.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/120.46744af2.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/121.4b27201b.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/122.c548b090.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/123.044456f5.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/124.6aac474e.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/125.8e00a9b6.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/126.99ba6e06.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/127.f6b7be8a.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/128.75b7e921.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/129.76022a94.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/13.a607d982.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/130.f902867a.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/131.03cf253a.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/132.1c5203ee.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/133.f5db158a.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/134.5e89a181.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/135.a78a0575.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/136.79d35729.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/137.bffed646.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/138.8c42b6d6.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/139.040f3045.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/14.d79c8f1e.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/140.2a88bdd3.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/141.314c4f9f.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/142.d12d49bd.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/143.9cbbb899.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/144.9a0f9fc3.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/145.6b4c53ba.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/146.e90184aa.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/147.a77f469f.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/148.92d6817c.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/149.b73611fd.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/15.aa8de9e4.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/150.be1fddce.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/151.e591529b.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/152.97924d35.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/153.d15648da.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/154.8b5dff85.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/155.cdcf1d60.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/156.107ad88f.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/157.b0c8c595.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/158.d989e0f9.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/159.4ddc8696.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/16.3ce6e134.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/160.79739905.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/161.96488285.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/162.402fda35.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/163.44503de6.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/164.d0df235d.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/165.8a571c54.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/166.b2055157.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/167.050a9c40.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/168.a60c78ff.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/169.0354c879.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/17.70099444.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/170.39cef4f0.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/171.1a5b6058.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/172.3bb728b3.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/173.4cf362d5.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/174.6e3ad708.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/175.cab89631.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/176.b82a46f9.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/177.4cbb6a71.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/178.8c499006.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/179.2767b479.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/18.34d6f7b7.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/180.6e7d1dfd.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/181.052f2819.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/182.8ddd891c.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/183.067bc46f.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/184.2e89909f.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/185.b6860179.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/186.fc072830.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/187.c3afcee3.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/188.f6465478.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/189.a806a3ff.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/19.ab6fa687.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/190.27c6897a.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/191.9f976442.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/192.9f355ed9.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/193.4e46cffd.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/194.25c2cf05.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/195.f9732d05.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/196.eb97040a.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/197.069069f7.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/198.128758a4.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/199.05a877fd.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/20.3ab523a9.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/200.4863189a.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/201.06b1f1ad.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/202.0242cf48.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/203.7430d00a.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/204.199cb7d3.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/205.4670b9e0.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/206.d8f5f797.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/207.9522b422.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/208.e4a444aa.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/209.c6ac382f.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/21.64bfec24.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/210.491cc3fe.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/211.17f05c05.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/212.e2e342aa.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/213.fee12cfc.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/214.e5938a65.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/215.756375e3.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/216.0664f98d.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/217.4bea6487.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/218.13dba294.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/219.6d3b3e0f.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/22.7d94c22e.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/220.9e50c661.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/221.61f02c6d.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/222.2beab6d5.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/223.b24b38a2.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/224.40e0b5b4.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/225.fc9b7f57.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/226.56961543.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/227.ec509037.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/228.52dcc19e.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/229.2a88f7ca.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/23.0574fbd1.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/230.68ced871.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/231.c1339007.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/232.eab16dee.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/233.1047874b.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/234.24824bfd.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/235.52c28d7c.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/24.7c5d8d64.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/25.e6c9e647.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/26.1299fa53.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/27.3b7d46f8.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/28.b8736b0c.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/29.2c27d631.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/3.01127c26.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/30.b0d51d95.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/32.f3b69614.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/33.19ceb001.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/34.52d17d6f.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/35.8710e200.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/36.23986b94.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/37.d94ce4a6.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/38.c6d878cb.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/39.8fa411e5.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/4.6d3811f4.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/40.eabe23f4.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/41.d5070f22.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/42.119289ea.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/43.b5203ec6.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/44.e6b5874c.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/45.bab22b5b.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/46.a66919b4.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/47.86a1cb82.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/48.c9e9a55f.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/49.93467694.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/5.c3a0f77b.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/50.89877706.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/51.4801d693.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/52.392fb642.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/53.b3478adb.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/54.cf3477b5.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/55.a03f953a.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/56.f3e27612.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/57.3ff68525.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/58.11a0d8e3.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/59.412e377f.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/6.32f798e8.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/60.f91d205c.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/61.79dbc3f8.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/62.20700973.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/63.168f3e3f.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/64.59cdc655.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/65.aa1133c1.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/66.02f04384.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/67.55088d50.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/68.a4cd23dc.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/69.09662135.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/7.34e49318.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/70.de496144.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/71.db327b21.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/72.41e99a83.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/73.15491adc.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/74.13660c7c.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/75.cb323858.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/76.6f41eb6f.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/77.ca3fb346.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/78.9476b072.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/79.78eaab98.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/8.661e7810.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/80.59183201.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/81.2eaf0f58.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/82.67aff3f3.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/83.fffee07f.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/84.e4f5c745.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/85.111fd253.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/86.24541381.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/87.b7a27802.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/88.ee9a5026.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/89.abbdf457.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/9.051025db.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/90.c0b53486.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/91.1b2c8c22.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/92.ab924418.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/93.d54ea6cd.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/94.4050d61a.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/95.3fe99253.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/96.469327c4.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/97.26b778ff.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/98.9be26d71.js"><link rel="prefetch" href="/xiaoze-blog/assets/js/99.50fa7663.js">
    <link rel="stylesheet" href="/xiaoze-blog/assets/css/0.styles.25451b68.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>小泽认真奋进</h3> <p class="description" data-v-59e6cb88></p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2024
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/xiaoze-blog/" class="home-link router-link-active"><img src="/xiaoze-blog/logo.png" alt="小泽认真奋进" class="logo"> <span class="site-name">小泽认真奋进</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/xiaoze-blog/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      前端
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/前端/jquery/jquery.html" class="nav-link"><i class="undefined"></i>
  jQuery笔记
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/前端/vue2/vue2.html" class="nav-link"><i class="undefined"></i>
  vue2
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/前端/vue3/1：创建vue3工程.html" class="nav-link"><i class="undefined"></i>
  vue3
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/前端/ES6/ES6语法.html" class="nav-link"><i class="undefined"></i>
  ES6
</a></li><li class="dropdown-item"><!----> <a href="https://www.baidu.com/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  其它链接
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      后端
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/java/Java面向对象.html" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/juc/1：线程基础.html" class="nav-link"><i class="undefined"></i>
  Juc
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/mybatis/1：mybatis入门教程.html" class="nav-link"><i class="undefined"></i>
  Mybatis
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/mybatisPlus/1：mybatisPlus相关业务.html" class="nav-link"><i class="undefined"></i>
  MybatisPlus
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/redis/redis基本数据类型.html" class="nav-link"><i class="undefined"></i>
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/spring/1：SpringAop.html" class="nav-link"><i class="undefined"></i>
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/springboot/1：SpringBoot拦截器.html" class="nav-link"><i class="undefined"></i>
  SpringBoot
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/springsecurity/1：SpringSecurity入门教程.html" class="nav-link"><i class="undefined"></i>
  SpringSecurity
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/springcloud/1：springcloud入门.html" class="nav-link"><i class="undefined"></i>
  SpringCloud
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/rabbitmq/1：RabbitMq.html" class="nav-link"><i class="undefined"></i>
  消息中间件
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/shardingsphere/1：shardingsphere基础.html" class="nav-link"><i class="undefined"></i>
  Shardingsphere
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/elasticSearch/1：docker安装elasticSearch.html" class="nav-link"><i class="undefined"></i>
  ElasticSearch
</a></li><li class="dropdown-item"><!----> <a href="https://www.baidu.com/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  其它链接
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      大数据
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/大数据/Flink/1：Flink概述.html" class="nav-link"><i class="undefined"></i>
  flink
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      运维
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/运维/docker/1：docker安装部署.html" class="nav-link"><i class="undefined"></i>
  docker
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      数据库
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/数据库/mysql/mysql基本语法.html" class="nav-link"><i class="undefined"></i>
  Mysql
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/数据库/oracle/oracle基本语法.html" class="nav-link"><i class="undefined"></i>
  Oracle
</a></li><li class="dropdown-item"><!----> <a href="https://www.runoob.com/mysql/mysql-tutorial.html" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  学习链接
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      算法
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>算法基础和思想</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/xiaoze-blog/blogs/算法/数据结构/1：数组和矩阵.html" class="nav-link"><i class="undefined"></i>
  数据结构基础
</a></li></ul></li><li class="dropdown-item"><h4>java</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/xiaoze-blog/blogs/算法/java/Java算法.html" class="nav-link"><i class="undefined"></i>
  Java
</a></li></ul></li><li class="dropdown-item"><h4>Mysql</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/xiaoze-blog/blogs/算法/MySQL/MySQL算法.html" class="nav-link"><i class="undefined"></i>
  Mysql
</a></li></ul></li><li class="dropdown-item"><!----> <a href="https://leetcode.cn/problemset/all/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  刷题链接
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      架构
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>设计模式</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/xiaoze-blog/blogs/架构/设计模式/1：单例模式.html" class="nav-link"><i class="undefined"></i>
  设计模式学习入口
</a></li></ul></li><li class="dropdown-item"><h4>分布式系统</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/xiaoze-blog/blogs/架构/分布式系统/1：全局唯一id实现方案.html" class="nav-link"><i class="undefined"></i>
  1：全局唯一id实现方案
</a></li><li class="dropdown-subitem"><a href="/xiaoze-blog/blogs/架构/分布式系统/2：经典限流算法.html" class="nav-link"><i class="undefined"></i>
  2：经典限流算法
</a></li><li class="dropdown-subitem"><a href="/xiaoze-blog/blogs/架构/分布式系统/3：如何做一个秒杀接口方案.html" class="nav-link"><i class="undefined"></i>
  3：如何做一个秒杀接口方案
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      其他
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/其他/maven基本知识.html" class="nav-link"><i class="undefined"></i>
  maven
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/其他/gitee.html" class="nav-link"><i class="undefined"></i>
  gitee
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/其他/linux.html" class="nav-link"><i class="undefined"></i>
  linux
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/其他/Nginx.html" class="nav-link"><i class="undefined"></i>
  nginx
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/其他/lua脚本.html" class="nav-link"><i class="undefined"></i>
  lua
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/python/基本语法/1：基本数据类型.html" class="nav-link"><i class="undefined"></i>
  python
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      好玩的东西
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/好玩的东西/cmd命令/1：cmd打开本地电脑文件.html" class="nav-link"><i class="undefined"></i>
  电脑杂货铺
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/好玩的东西/markdown语法/markdown.html" class="nav-link"><i class="undefined"></i>
  markdown语法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      工具集合
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/工具/css/h5/h5.html" class="nav-link"><i class="undefined"></i>
  常用css
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/工具/spring/springboot/自定义注解/1：自定义校验字段注解.html" class="nav-link"><i class="undefined"></i>
  spring工具
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/工具/redis/redis工具类/1：redisUtils快捷操作redis.html" class="nav-link"><i class="undefined"></i>
  redis工具
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/面试/Java基础上.html" class="nav-link"><i class="undefined"></i>
  面试大全
</a></li></ul></div></div><div class="nav-item"><a href="/xiaoze-blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/xiaoze-blog/titletop.jpg" alt="author-avatar" class="personal-img" data-v-1fad0c41> <!----> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>223</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>42</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41><li class="social-item" data-v-1fad0c41><i class="iconfont reco-github" style="color:#f47e60;" data-v-1fad0c41></i></li><li class="social-item" data-v-1fad0c41><i class="iconfont reco-mayun" style="color:#f47e60;" data-v-1fad0c41></i></li><li class="social-item" data-v-1fad0c41><i class="iconfont reco-csdn" style="color:#abbd81;" data-v-1fad0c41></i></li></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/xiaoze-blog/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      前端
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/前端/jquery/jquery.html" class="nav-link"><i class="undefined"></i>
  jQuery笔记
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/前端/vue2/vue2.html" class="nav-link"><i class="undefined"></i>
  vue2
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/前端/vue3/1：创建vue3工程.html" class="nav-link"><i class="undefined"></i>
  vue3
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/前端/ES6/ES6语法.html" class="nav-link"><i class="undefined"></i>
  ES6
</a></li><li class="dropdown-item"><!----> <a href="https://www.baidu.com/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  其它链接
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      后端
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/java/Java面向对象.html" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/juc/1：线程基础.html" class="nav-link"><i class="undefined"></i>
  Juc
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/mybatis/1：mybatis入门教程.html" class="nav-link"><i class="undefined"></i>
  Mybatis
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/mybatisPlus/1：mybatisPlus相关业务.html" class="nav-link"><i class="undefined"></i>
  MybatisPlus
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/redis/redis基本数据类型.html" class="nav-link"><i class="undefined"></i>
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/spring/1：SpringAop.html" class="nav-link"><i class="undefined"></i>
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/springboot/1：SpringBoot拦截器.html" class="nav-link"><i class="undefined"></i>
  SpringBoot
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/springsecurity/1：SpringSecurity入门教程.html" class="nav-link"><i class="undefined"></i>
  SpringSecurity
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/springcloud/1：springcloud入门.html" class="nav-link"><i class="undefined"></i>
  SpringCloud
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/rabbitmq/1：RabbitMq.html" class="nav-link"><i class="undefined"></i>
  消息中间件
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/shardingsphere/1：shardingsphere基础.html" class="nav-link"><i class="undefined"></i>
  Shardingsphere
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/后端/elasticSearch/1：docker安装elasticSearch.html" class="nav-link"><i class="undefined"></i>
  ElasticSearch
</a></li><li class="dropdown-item"><!----> <a href="https://www.baidu.com/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  其它链接
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      大数据
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/大数据/Flink/1：Flink概述.html" class="nav-link"><i class="undefined"></i>
  flink
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      运维
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/运维/docker/1：docker安装部署.html" class="nav-link"><i class="undefined"></i>
  docker
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      数据库
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/数据库/mysql/mysql基本语法.html" class="nav-link"><i class="undefined"></i>
  Mysql
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/数据库/oracle/oracle基本语法.html" class="nav-link"><i class="undefined"></i>
  Oracle
</a></li><li class="dropdown-item"><!----> <a href="https://www.runoob.com/mysql/mysql-tutorial.html" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  学习链接
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      算法
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>算法基础和思想</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/xiaoze-blog/blogs/算法/数据结构/1：数组和矩阵.html" class="nav-link"><i class="undefined"></i>
  数据结构基础
</a></li></ul></li><li class="dropdown-item"><h4>java</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/xiaoze-blog/blogs/算法/java/Java算法.html" class="nav-link"><i class="undefined"></i>
  Java
</a></li></ul></li><li class="dropdown-item"><h4>Mysql</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/xiaoze-blog/blogs/算法/MySQL/MySQL算法.html" class="nav-link"><i class="undefined"></i>
  Mysql
</a></li></ul></li><li class="dropdown-item"><!----> <a href="https://leetcode.cn/problemset/all/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  刷题链接
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      架构
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>设计模式</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/xiaoze-blog/blogs/架构/设计模式/1：单例模式.html" class="nav-link"><i class="undefined"></i>
  设计模式学习入口
</a></li></ul></li><li class="dropdown-item"><h4>分布式系统</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/xiaoze-blog/blogs/架构/分布式系统/1：全局唯一id实现方案.html" class="nav-link"><i class="undefined"></i>
  1：全局唯一id实现方案
</a></li><li class="dropdown-subitem"><a href="/xiaoze-blog/blogs/架构/分布式系统/2：经典限流算法.html" class="nav-link"><i class="undefined"></i>
  2：经典限流算法
</a></li><li class="dropdown-subitem"><a href="/xiaoze-blog/blogs/架构/分布式系统/3：如何做一个秒杀接口方案.html" class="nav-link"><i class="undefined"></i>
  3：如何做一个秒杀接口方案
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      其他
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/其他/maven基本知识.html" class="nav-link"><i class="undefined"></i>
  maven
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/其他/gitee.html" class="nav-link"><i class="undefined"></i>
  gitee
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/其他/linux.html" class="nav-link"><i class="undefined"></i>
  linux
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/其他/Nginx.html" class="nav-link"><i class="undefined"></i>
  nginx
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/其他/lua脚本.html" class="nav-link"><i class="undefined"></i>
  lua
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/python/基本语法/1：基本数据类型.html" class="nav-link"><i class="undefined"></i>
  python
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      好玩的东西
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/好玩的东西/cmd命令/1：cmd打开本地电脑文件.html" class="nav-link"><i class="undefined"></i>
  电脑杂货铺
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/好玩的东西/markdown语法/markdown.html" class="nav-link"><i class="undefined"></i>
  markdown语法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      工具集合
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/工具/css/h5/h5.html" class="nav-link"><i class="undefined"></i>
  常用css
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/工具/spring/springboot/自定义注解/1：自定义校验字段注解.html" class="nav-link"><i class="undefined"></i>
  spring工具
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/工具/redis/redis工具类/1：redisUtils快捷操作redis.html" class="nav-link"><i class="undefined"></i>
  redis工具
</a></li><li class="dropdown-item"><!----> <a href="/xiaoze-blog/blogs/面试/Java基础上.html" class="nav-link"><i class="undefined"></i>
  面试大全
</a></li></ul></div></div><div class="nav-item"><a href="/xiaoze-blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>后端</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>java</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xiaoze-blog/blogs/后端/java/Java面向对象.html" class="sidebar-link">1：java面向对象</a></li><li><a href="/xiaoze-blog/blogs/后端/java/Java反射.html" class="sidebar-link">2：java反射</a></li><li><a href="/xiaoze-blog/blogs/后端/java/Java-Stream大全.html" class="sidebar-link">3：Stream</a></li><li><a href="/xiaoze-blog/blogs/后端/java/Java位运算符详解.html" class="sidebar-link">4：Java位运算符详解</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>Juc</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xiaoze-blog/blogs/后端/juc/1：线程基础.html" class="sidebar-link">1：线程基础</a></li><li><a href="/xiaoze-blog/blogs/后端/juc/2：CompletableFuture.html" class="sidebar-link">2：CompletableFuture</a></li><li><a href="/xiaoze-blog/blogs/后端/juc/2：CompletableFuture个人代码.html" class="sidebar-link">2：CompletableFuture个人代码</a></li><li><a href="/xiaoze-blog/blogs/后端/juc/3：Java锁.html" class="sidebar-link">3：Java锁</a></li><li><a href="/xiaoze-blog/blogs/后端/juc/4：LockSupport与线程中断.html" class="sidebar-link">4：LockSupport与线程中断</a></li><li><a href="/xiaoze-blog/blogs/后端/juc/5：Java内存模型之JMM.html" class="sidebar-link">5：Java内存模型之JMM</a></li><li><a href="/xiaoze-blog/blogs/后端/juc/6：volatile与Java内存模型.html" class="sidebar-link">6：volatile与Java内存模型</a></li><li><a href="/xiaoze-blog/blogs/后端/juc/7：CAS.html" class="sidebar-link">7：CAS</a></li><li><a href="/xiaoze-blog/blogs/后端/juc/8：原子操作类之18罗汉增强.html" class="sidebar-link">8：原子操作类之18罗汉增强</a></li><li><a href="/xiaoze-blog/blogs/后端/juc/9：聊聊ThreadLocal.html" class="sidebar-link">9：聊聊ThreadLocal</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>mybatis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xiaoze-blog/blogs/后端/mybatis/1：mybatis入门教程.html" class="sidebar-link">1：mybatis入门教程</a></li><li><a href="/xiaoze-blog/blogs/后端/mybatis/2：mybatis常用sql大全.html" class="sidebar-link">2：mybatis常用sql大全</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>mybatisPlus</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xiaoze-blog/blogs/后端/mybatisPlus/1：mybatisPlus相关业务.html" class="sidebar-link">1：mybatisPlus相关业务</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>redis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xiaoze-blog/blogs/后端/redis/redis基本数据类型.html" class="sidebar-link">1：redis基本数据类型</a></li><li><a href="/xiaoze-blog/blogs/后端/redis/缓存击穿，穿透解决.html" class="sidebar-link">2：缓存击穿、穿透解决办法</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>spring</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xiaoze-blog/blogs/后端/spring/1：SpringAop.html" class="sidebar-link">1：SpringAop</a></li><li><a href="/xiaoze-blog/blogs/后端/spring/2：SpringIoc实现以及原理.html" class="sidebar-link">2：SpringIoc实现以及原理</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>springboot</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xiaoze-blog/blogs/后端/springboot/1：SpringBoot拦截器.html" class="sidebar-link">1：SpringBoot拦截器</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>springSecurity</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xiaoze-blog/blogs/后端/springSecurity/1：SpringSecurity入门教程.html" class="sidebar-link">1：SpringSecurity入门教程</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>springcloud</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xiaoze-blog/blogs/后端/springcloud/1：springcloud入门.html" class="sidebar-link">1：springcloud入门</a></li><li><a href="/xiaoze-blog/blogs/后端/springcloud/2：eureka服务注册.html" class="sidebar-link">2：eureka服务注册</a></li><li><a href="/xiaoze-blog/blogs/后端/springcloud/3：ribbon负载均衡.html" class="sidebar-link">3：ribbon负载均衡</a></li><li><a href="/xiaoze-blog/blogs/后端/springcloud/4：Nacos注册中心.html" class="sidebar-link">4：Nacos注册中心</a></li><li><a href="/xiaoze-blog/blogs/后端/springcloud/5：Nacos配置管理.html" class="sidebar-link">5：Nacos配置管理</a></li><li><a href="/xiaoze-blog/blogs/后端/springcloud/6：Feign远程调用.html" class="sidebar-link">6：Feign远程调用</a></li><li><a href="/xiaoze-blog/blogs/后端/springcloud/7：Gateway服务网关.html" class="sidebar-link">7：Gateway服务网关</a></li><li><a href="/xiaoze-blog/blogs/后端/springcloud/8：Hystrix熔断降级.html" class="sidebar-link">8：Hystrix熔断降级</a></li><li><a href="/xiaoze-blog/blogs/后端/springcloud/9：Config分布式配置中心.html" class="sidebar-link">9：Config分布式配置中心</a></li><li><a href="/xiaoze-blog/blogs/后端/springcloud/10：消息总线Bus.html" class="sidebar-link">10：消息总线Bus</a></li><li><a href="/xiaoze-blog/blogs/后端/springcloud/11：消息驱动Stream.html" class="sidebar-link">11：消息驱动Stream</a></li><li><a href="/xiaoze-blog/blogs/后端/springcloud/12：链路追踪Sleuth.html" class="sidebar-link">12：链路追踪Sleuth</a></li><li><a href="/xiaoze-blog/blogs/后端/springcloud/13：Sentinel.html" class="sidebar-link">13：Sentinel</a></li><li><a href="/xiaoze-blog/blogs/后端/springcloud/14：Seata.html" class="sidebar-link">14：Seata</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>消息中间件</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-2"><p class="sidebar-heading open"><span>rabbitmq</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xiaoze-blog/blogs/后端/rabbitmq/1：RabbitMq.html" class="sidebar-link">1：RabbitMq</a></li><li><a href="/xiaoze-blog/blogs/后端/rabbitmq/2：Rabbitmq常见问题解决方案.html" class="active sidebar-link">2：Rabbitmq常见问题解决方案</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-2"><p class="sidebar-heading"><span>rocketmq</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xiaoze-blog/blogs/后端/rocketmq/1：RocketMq.html" class="sidebar-link">1：RocketMq</a></li><li><a href="/xiaoze-blog/blogs/后端/rocketmq/2：RocketMq简单集成文档.html" class="sidebar-link">2：RocketMq简单集成文档</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>分库分表</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-2"><p class="sidebar-heading open"><span>shardingsphere</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xiaoze-blog/blogs/后端/shardingsphere/1：shardingsphere基础.html" class="sidebar-link">1：shardingsphere基础</a></li><li><a href="/xiaoze-blog/blogs/后端/shardingsphere/2：shardingjdbc.html" class="sidebar-link">2：shardingjdbc</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>elasticSearch</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xiaoze-blog/blogs/后端/elasticSearch/1：docker安装elasticSearch.html" class="sidebar-link">1：docker安装elasticSearch</a></li><li><a href="/xiaoze-blog/blogs/后端/elasticSearch/2：windows安装elasticSearch.html" class="sidebar-link">2：windows安装elasticSearch</a></li><li><a href="/xiaoze-blog/blogs/后端/elasticSearch/3：初识elasticsearch.html" class="sidebar-link">3：初识elasticsearch</a></li><li><a href="/xiaoze-blog/blogs/后端/elasticSearch/4：DSL语法操作索引库和文档.html" class="sidebar-link">4：DSL语法操作索引库和文档</a></li><li><a href="/xiaoze-blog/blogs/后端/elasticSearch/5：RestClient操作索引库和文档.html" class="sidebar-link">5：RestClient操作索引库和文档</a></li><li><a href="/xiaoze-blog/blogs/后端/elasticSearch/6：DSL语法查询文档.html" class="sidebar-link">6：DSL语法查询文档</a></li><li><a href="/xiaoze-blog/blogs/后端/elasticSearch/7：DSL搜索结果处理.html" class="sidebar-link">7：DSL搜索结果处理</a></li><li><a href="/xiaoze-blog/blogs/后端/elasticSearch/8：RestClient查询文档.html" class="sidebar-link">8：RestClient查询文档</a></li><li><a href="/xiaoze-blog/blogs/后端/elasticSearch/9：搜索案例实现.html" class="sidebar-link">9：搜索案例实现</a></li><li><a href="/xiaoze-blog/blogs/后端/elasticSearch/10：数据聚合和自动补全.html" class="sidebar-link">10：数据聚合和自动补全</a></li><li><a href="/xiaoze-blog/blogs/后端/elasticSearch/11：数据同步.html" class="sidebar-link">11：数据同步</a></li></ul></section></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>2：Rabbitmq常见问题解决方案</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2024
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">2：Rabbitmq常见问题解决方案</h1> <div data-v-8a445198><!----> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>5/11/2024</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>rabbit</span></i></div></div> <div class="theme-reco-content content__default"><h2 id="_1-rabbitmq的可靠性-消息丢失问题"><a href="#_1-rabbitmq的可靠性-消息丢失问题" class="header-anchor">#</a> 1. RabbitMQ的可靠性（消息丢失问题）</h2> <p>消息可靠性问题举例：</p> <p><img src="/xiaoze-blog/assets/img/image1.5ee1f361.png" alt="alt text"></p> <blockquote><p>以 <strong>创建订单</strong> 为例，可能会出现这样的业务场景</p></blockquote> <ul><li><strong>MQ 挂了，消息没发出去。创建订单后面几个优惠券、积分的下游系统全都没有执行业务结算怎么办？</strong></li> <li><strong>MQ 是高可用的，消息发出去了，但是优惠券结算业务报错了怎么办？因为这个是异步的，也不好去回滚</strong></li> <li><strong>消息正常发出去，消费者也接收到了，商户系统、优惠券系统都正常执行完了，积分业务报错了导致积分没结算，那这个订单的数据就不一致了</strong></li></ul> <blockquote><p>要解决上述问题，就是要 <strong>保证消息一定要可靠的被消费</strong>，那么我们可以来分析下消息有哪些步骤会出问题</p></blockquote> <p><img src="/xiaoze-blog/assets/img/image2.f3683e1e.png" alt="alt text"></p> <blockquote><p>RabbitMQ出现消息可靠性问题的常见情况：</p></blockquote> <ul><li><strong>生产者消息没到交换机，相当于生产者弄丢消息</strong></li> <li><strong>交换机没有把消息路由到队列，相当于生产者弄丢消息</strong></li> <li><strong>RabbitMQ 宕机导致队列、队列中的消息丢失，相当于 RabbitMQ 弄丢消息</strong></li> <li><strong>消费者消费出现异常，业务没执行，相当于消费者弄丢消息</strong></li></ul> <h3 id="_1-1-生产者丢失消息"><a href="#_1-1-生产者丢失消息" class="header-anchor">#</a> 1.1 生产者丢失消息</h3> <blockquote><p>异步监听机制：</p></blockquote> <ul><li>①成功/未成功发送到交换机可以触发一个  <code>confirm-type</code> 监听</li> <li>②交换机发送到队列会有一个 <code>publisher-returns</code> 监听</li></ul> <blockquote><p>具体操作：</p></blockquote> <p>以 SpringBoot 整合 RabbitMQ 为例</p> <p>引入依赖 starter</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>配置文件</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">publisher-returns</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">publisher-confirm-type</span><span class="token punctuation">:</span> correlated <span class="token comment">#新版本 publisher-confirms: true 已过时</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>然后编写监听回调</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitMQConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">enableConfirmCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//confirm 监听，当消息成功发到交换机 ack = true，没有发送到交换机 ack = false</span>
        <span class="token comment">//correlationData 可在发送时指定消息唯一 id</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setConfirmCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span>correlationData<span class="token punctuation">,</span> ack<span class="token punctuation">,</span> cause<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>ack<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//记录日志、发送邮件通知、落库定时任务扫描重发</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//当消息成功发送到交换机没有路由到队列触发此监听</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setReturnsCallback</span><span class="token punctuation">(</span>returned <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">//记录日志、发送邮件通知、落库定时任务扫描重发</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>测试的时候可以在发送消息时故意写错交换机、路由键的名称，然后就会回调到我们刚刚写的监听方法， cause 会给我们展示具体没有发到交换机的原因；returned 对象中包含了消息相关信息。</p> <p><strong>但是一般不这样用，成本太高丢失概率很低。一般采用日志/邮件记录，手动维护。</strong></p> <p>即RabbitMQ 本身丢失的可能性就非常低，其次如果这里需要落库再用定时任务扫描重发还要开发一堆代码，分布式定时任务…再其次定时任务扫描肯定会增加消息延迟，不是很有必要。真实业务场景是记录一下日志就行了，方便问题回溯，顺便发个邮件给相关人员，如果真的极其罕见的是生产者弄丢消息，那么开发往数据库补数据就行了。</p> <h3 id="_1-2-rabbitmq弄丢消息"><a href="#_1-2-rabbitmq弄丢消息" class="header-anchor">#</a> 1.2 Rabbitmq弄丢消息</h3> <p>设置 <strong>持久化</strong> 将消息写出磁盘（<strong>重启后消息仍然存在</strong>），否则RabbitMQ重启后所有队列和消息都会丢失。</p> <blockquote><p>持久化操作：</p></blockquote> <p>持久化分为三种</p> <ul><li>交换机持久化</li> <li>队列持久化</li> <li>消息持久化</li></ul> <h4 id="_1-2-1-交换机持久化"><a href="#_1-2-1-交换机持久化" class="header-anchor">#</a> 1.2.1 交换机持久化</h4> <p>交换机持久化描述的是当这个交换机上没有注册队列时，这个交换机是否删除。如果要打开持久化的话也很简单</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DirectExchange</span> <span class="token function">testDirectExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	    <span class="token comment">//第二个参数就是是否持久化，第三个参数就是是否自动删除</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DirectExchange</span><span class="token punctuation">(</span><span class="token string">&quot;direct.Exchange&quot;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>消费者类上的注解：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>
        bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
                value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;direct.Queue&quot;</span><span class="token punctuation">,</span>autoDelete <span class="token operator">=</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;direct.Exchange&quot;</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">ExchangeTypes</span><span class="token punctuation">.</span><span class="token constant">DIRECT</span><span class="token punctuation">,</span>durable <span class="token operator">=</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                key <span class="token operator">=</span> <span class="token string">&quot;direct.Rout&quot;</span>
        <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><code>@Exchange</code>注解的 <code>durable属性</code> 设置为 <code>true</code> ( <strong>默认也是true，不设置也可以</strong>)。这样，<strong>即使这个交换机没有队列，也不会被删除</strong></p> <h4 id="_1-2-2-队列持久化"><a href="#_1-2-2-队列持久化" class="header-anchor">#</a> 1.2.2 队列持久化</h4> <p>队列持久化描述的是 <strong>当这个队列没有消费者在监听时，是否进行删除。持久化做法</strong>：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">txQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//第二个参数就是durable，是否持久化</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">&quot;txQueue&quot;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>消费者类的注解：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>
        bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
                value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;direct.Queue&quot;</span><span class="token punctuation">,</span>autoDelete <span class="token operator">=</span> <span class="token string">&quot;false&quot;</span><span class="token punctuation">,</span>durable <span class="token operator">=</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;direct.Exchange&quot;</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">ExchangeTypes</span><span class="token punctuation">.</span><span class="token constant">DIRECT</span><span class="token punctuation">,</span>durable <span class="token operator">=</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                key <span class="token operator">=</span> <span class="token string">&quot;direct.Rout&quot;</span>
        <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>可以看到，<code>@Queue</code> 注解上，加上了 <code>durable=&quot;true&quot;</code> 的注解。这样 <strong>队列在重启的时候就不会被删除了</strong></p> <h4 id="_1-2-3-消息持久化"><a href="#_1-2-3-消息持久化" class="header-anchor">#</a> 1.2.3 消息持久化</h4> <p><code>消息持久化</code> 和 <code>前面两个</code> 稍微有点不同。消息持久化实际上就是基于 <strong>确认机制</strong> 去做的。<strong>默认情况下，只要消费者接收到这个消息，这个消息就从队列上被删除了。</strong></p> <p>但考虑这样一种场景，接口层接受到一个请求，然后推送一个消息，异步地去更新数据库。此时对于消费者端来说，一拿到消息，消息就从队列上被删除，然后开始执行数据库更新，但此时数据库更新失败了，方法直接返回。但队列上已经没有这条消息了，这个更新操作不就没有完成了吗？这肯定是有问题的。</p> <p>所以RabbitMQ就有了 <strong>消费者确认机制</strong>，只有消费者手动确认，消息才会被删除，否则该消息将一直存在队列中，开启的方法很简单：</p> <p><code>application.properties</code>上加上：</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code>spring.rabbitmq.listener.simple.acknowledge<span class="token punctuation">-</span>mode=manual
// 意为改为手动确认。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>对于消费者端：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RabbitHandler</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">,</span><span class="token class-name">Channel</span> channel<span class="token punctuation">,</span><span class="token class-name">Message</span> message<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//手动调用</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>手动调用下确认即可，消息就会被删除。这一步可以放在业务逻辑的执行之后</strong></p> <h3 id="_1-3-消费者弄丢消息"><a href="#_1-3-消费者弄丢消息" class="header-anchor">#</a> 1.3 消费者弄丢消息</h3> <p>消费者丢数据一般是因为采用了 <strong>自动确认消息模式</strong> 。<strong>MQ收到确认消息后会删除消息，如果这时消费者异常了，那消息就没了。</strong></p> <p>即消费端执行业务代码报错，导致业务未执行，比较常见，属于业务代码异常，一定要解决。如：创建订单成功了，优惠券结算报错了，<strong>默认情况下 RabbitMQ 只要把消息推送到消费者就会认为消息已经被消费</strong>，就从队列中删除了，但是优惠券还没有结算，这样就相当于消息变相丢失了。</p> <p><strong>可以使用ack机制，默认情况下自动应答，可以使用手动ack，然后再删除消息</strong></p> <blockquote><p>具体操作：</p></blockquote> <p><strong>首先在配置文件中开启手动 ack</strong></p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">listener</span><span class="token punctuation">:</span>
      <span class="token key atrule">simple</span><span class="token punctuation">:</span>
        <span class="token key atrule">acknowledge-mode</span><span class="token punctuation">:</span> manual <span class="token comment">#手动应答</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>然后在 <strong>消费端代码</strong> 中 <strong>手动应答签收消息</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">&quot;queue&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token class-name">String</span> object<span class="token punctuation">,</span> <span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> deliveryTag <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;消费成功：{},消息内容:{}&quot;</span><span class="token punctuation">,</span> deliveryTag<span class="token punctuation">,</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">/**
             * 执行业务代码...
             * */</span>
            channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;签收失败&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                channel<span class="token punctuation">.</span><span class="token function">basicNack</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;拒签失败&quot;</span><span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><blockquote><p>但是在实际场景中，设置ack后，让消息重回队列会回到队列顶端，继续推送到服务端，<strong>通常的代码报错并不能因为重试而解决，可能会造成死循环</strong>。所以这样的场景一般有三个选择：</p></blockquote> <ul><li>当消费失败后将此消息存到 Redis，记录消费次数，如果消费了三次还是失败，就丢弃掉消息，记录日志落库保存</li> <li>直接填 false ，不重回队列，记录日志、发送邮件等待开发手动处理</li> <li>不启用手动 ack ，使用 SpringBoot 提供的消息重试</li></ul> <blockquote><p>SpringBoot 提供的消息重试：</p></blockquote> <p>其实很多场景并不是一定要启用消费者应答模式，<strong>因为 SpringBoot 给我们提供了一种重试机制，当消费者执行的业务方法报错时会重试执行消费者业务方法。</strong></p> <p>启用 SpringBoot 提供的重试机制</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">listener</span><span class="token punctuation">:</span>
      <span class="token key atrule">simple</span><span class="token punctuation">:</span>
        <span class="token key atrule">retry</span><span class="token punctuation">:</span>
          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">max-attempts</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment">#重试次数</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>消费者代码</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">&quot;queue&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token class-name">String</span> object<span class="token punctuation">,</span> <span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">/**
             * 执行业务代码...
             * */</span>
            <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//故意报错测试</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;签收失败&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">/**
             * 记录日志、发送邮件、保存消息到数据库，落库之前判断如果消息已经落库就不保存
             * */</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;消息消费失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><strong>注意一定要手动 throw 一个异常，因为 SpringBoot 触发重试是根据方法中发生未捕捉的异常来决定的。</strong> 值得注意的是这个重试是 SpringBoot 提供的，重新执行消费者方法，而不是让 RabbitMQ 重新推送消息。</p> <h3 id="_1-4-小节"><a href="#_1-4-小节" class="header-anchor">#</a> 1.4 小节</h3> <p>其实认真研究下来你会发现所谓的 <strong>消息可靠性本身就是无法保证的</strong> …所谓的各种可靠性机制只是为了以后消息丢失提供可查询的日志而已，不过 <strong>通过这些机制耗费一些（巨大）成本的确是能够缩小消息丢失的可能性。</strong></p> <h2 id="_2-重复消费问题-消息幂等性"><a href="#_2-重复消费问题-消息幂等性" class="header-anchor">#</a> 2. 重复消费问题（消息幂等性）</h2> <p>为了 <strong>防止消息在消费者端丢失，会采用手动回复MQ的方式来解决</strong> ，同时也引出了一个问题，消费者处理消息成功，手动回复MQ时，<strong>由于网络不稳定，连接断开，导致MQ没有收到消费者回复的消息，那么该条消息还会保存在MQ的消息队列，由于MQ的消息重发机制，会重新把该条消息发给和该队列绑定的消息者处理，这样就会导致消息重复消费</strong>。而有些操作是不允许重复消费的，比如下单，减库存，扣款等操作。</p> <h3 id="_2-1-生产时消息重复"><a href="#_2-1-生产时消息重复" class="header-anchor">#</a> 2.1 生产时消息重复</h3> <p>由于生产者发送消息给MQ，<strong>在MQ确认的时候出现了网络波动，生产者没有收到确认</strong>，实际上MQ已经接收到了消息。这时候生产者就会重新发送一遍这条消息。</p> <p>生产者中如果消息未被确认，或确认失败，我们可以使用 <strong>定时任务+（redis/db）</strong> 来进行消息重试。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4J</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SendMessage</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MessageService</span> messageService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>

    <span class="token comment">// 最大投递次数</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MAX_TRY_COUNT</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 每30s拉取投递失败的消息, 重新投递
     */</span>
    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">&quot;0/30 * * * * ?&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">resend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;开始执行定时任务(重新投递消息)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MsgLog</span><span class="token punctuation">&gt;</span></span> msgLogs <span class="token operator">=</span> messageService<span class="token punctuation">.</span><span class="token function">selectTimeoutMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        msgLogs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>msgLog <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> msgId <span class="token operator">=</span> msgLog<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>msgLog<span class="token punctuation">.</span><span class="token function">getTryCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token constant">MAX_TRY_COUNT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                messageService<span class="token punctuation">.</span><span class="token function">updateStatus</span><span class="token punctuation">(</span>msgId<span class="token punctuation">,</span> <span class="token class-name">Constant<span class="token punctuation">.</span>MsgLogStatus</span><span class="token punctuation">.</span><span class="token constant">DELIVER_FAIL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;超过最大重试次数, 消息投递失败, msgId: {}&quot;</span><span class="token punctuation">,</span> msgId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                messageService<span class="token punctuation">.</span><span class="token function">updateTryCount</span><span class="token punctuation">(</span>msgId<span class="token punctuation">,</span> msgLog<span class="token punctuation">.</span><span class="token function">getNextTryTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 投递次数+1</span>

                <span class="token class-name">CorrelationData</span> correlationData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CorrelationData</span><span class="token punctuation">(</span>msgId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>msgLog<span class="token punctuation">.</span><span class="token function">getExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msgLog<span class="token punctuation">.</span><span class="token function">getRoutingKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">MessageHelper</span><span class="token punctuation">.</span><span class="token function">objToMsg</span><span class="token punctuation">(</span>msgLog<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> correlationData<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 重新投递</span>

                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;第 &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>msgLog<span class="token punctuation">.</span><span class="token function">getTryCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; 次重新投递消息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;定时任务执行结束(重新投递消息)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p><strong>也可以生产消息时，具备唯一ID，消费时通过消费端进行处理（参看消费重复的解决方案）。</strong></p> <h3 id="_2-2-消费时消息重复"><a href="#_2-2-消费时消息重复" class="header-anchor">#</a> 2.2 消费时消息重复</h3> <blockquote><p>两个思路：</p></blockquote> <ul><li>不让消费端执行两次</li> <li>让它重复消费了，但是不让其对业务数据造成影响</li></ul> <h4 id="_2-2-1-确保消费端只执行一次"><a href="#_2-2-1-确保消费端只执行一次" class="header-anchor">#</a> 2.2.1 确保消费端只执行一次</h4> <p>一般来说消息重复消费都是在 <strong>短暂的一瞬间消费多次</strong>，我们可以使用 <strong>redis 将消费过的消息唯一标识存储起来，然后在消费端业务执行之前判断 redis 中是否已经存在这个标识</strong>。</p> <p>举个例子，订单使用优惠券后，要通知优惠券系统，增加使用流水。这里可以用订单号 + 优惠券 id 做唯一标识。业务开始先判断 redis 是否已经存在这个标识，如果已经存在代表处理过了。不存在就放进 redis 设置过期时间，执行业务。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Boolean</span> flag <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span><span class="token string">&quot;orderNo+couponId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//先检查这条消息是不是已经消费过了</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//执行业务...</span>
    <span class="token comment">//消费过的标识存储到 Redis，10 秒过期</span>
    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;orderNo+couponId&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">10L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="_2-2-2-允许消费端执行多次-保证数据不受影响"><a href="#_2-2-2-允许消费端执行多次-保证数据不受影响" class="header-anchor">#</a> 2.2.2 允许消费端执行多次，保证数据不受影响</h4> <blockquote><p>数据库唯一键约束</p></blockquote> <p>如果消费端业务是 <strong>新增操作</strong>，我们可以 <strong>利用数据库的唯一键约束</strong>，比如优惠券流水表的优惠券编号，如果重复消费将会插入两条相同的优惠券编号记录，数据库会给我们报错，可以保证数据库数据不会插入两条。</p> <blockquote><p>数据库 <strong>乐观锁思想</strong></p></blockquote> <p>如果消费端业务是更新操作，可以给业务表加一个 version 字段，每次更新把 <code>version</code> 作为条件，更新之后 <code>version + 1</code>。由于 <code>MySQL</code> 的 <code>innoDB</code> 是行锁，当其中一个请求成功更新之后，另一个请求才能进来，由于版本号 <code>version</code> 已经变成 2，必定更新的 SQL 语句影响行数为 0，不会影响数据库数据。</p> <h3 id="_2-3-示例"><a href="#_2-3-示例" class="header-anchor">#</a> 2.3 示例</h3> <p>使用 <strong>uuid + redis</strong> 实现消息幂等性</p> <p>发送者模拟，使用uuid作为本消息的唯一id</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSendMessage2SimpleQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> queueName <span class="token operator">=</span> <span class="token string">&quot;simple.queue&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">&quot;hello,spring amqp你好&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">//设置请求头</span>
        <span class="token class-name">MessageProperties</span> messageProperties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> messageID <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>messageID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        messageProperties<span class="token punctuation">.</span><span class="token function">setMessageId</span><span class="token punctuation">(</span>messageID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Message</span> message1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> messageProperties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> message1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>另外一种写法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSendMessage2SimpleQueue1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> queueName <span class="token operator">=</span> <span class="token string">&quot;simple.queue&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">&quot;hello,spring amqp你好&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> messageID <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>message<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">CorrelationData</span><span class="token punctuation">(</span>messageID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>消费者就可以去判断</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;simple.queue&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenSimpleQueue</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">,</span> <span class="token class-name">Message</span> message<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消费者接收到simple.queue的消息：&quot;</span><span class="token operator">+</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMessageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取消息id，也就是生产者中的uuid</span>
        <span class="token class-name">String</span> msgId <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMessageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 1、通过redis去判断该消息是否已经存在，存在则代表已经消费，直接返回，不存在的话再进行消费</span>
        <span class="token class-name">Boolean</span> flag <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>msgId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//先检查这条消息是不是已经消费过了</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//执行业务...</span>
        <span class="token comment">//消费过的标识存储到 Redis，10 秒过期</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>msgId<span class="token punctuation">,</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">10L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="_3-消息消费顺序性问题"><a href="#_3-消息消费顺序性问题" class="header-anchor">#</a> 3. 消息消费顺序性问题</h2> <p>举例：</p> <ul><li>比如一个电商的 <strong>下单操作</strong>，下单后 <strong>先减库存</strong> 然后 <strong>生成订单</strong>，这个操作就需要 <strong>顺序执行</strong>的 那怎么保证顺序呢？</li> <li>有些业务场景会需要 <strong>让消息顺序消费</strong>，比如使用 <code>canal 订阅 MySQL 的 binary 日志</code>来更新 <code>Redis</code>，通常我们会把 canal 订阅到的数据变化发送到消息队列。</li></ul> <p><img src="/xiaoze-blog/assets/img/image3.0685aef4.png" alt="alt text"></p> <p><strong>如果不保证 RabbitMQ 的顺序消费， Redis 中就有可能会出现脏数据。</strong></p> <blockquote><p>原因：</p></blockquote> <p>其实队列本身是有顺序的，但是生产环境服务实例一般都是 <strong>集群</strong>，当消费者是多个实例时，队列中的消息会分发到所有实例进行消费（同一个消息只能发给一个消费者实例），这样就不能保证消息顺序的消费，因为你不能确保哪台机器执行消费端业务代码的速度快。</p> <p><img src="/xiaoze-blog/assets/img/image4.16d67c7a.png" alt="alt text"></p> <blockquote><p>解决消费顺序问题的思路：</p> <ul><li>1、多个消费实例并发竞争时，不能保证消费顺序，<strong>那么每次RabbitMQ只投递一个消息，待收到ack确认时再投递下一个</strong>，即可解决问题。在并发和性能要求高的情况下不适用：
<ul><li>每次只有一个消费者可消费，其他消费者被阻塞，降低了消费端的性能和并发能力。</li> <li>大大提高了消息积压的风险。</li></ul></li> <li>2、根据一定的策略，多个消费者按序消费。</li></ul></blockquote> <h3 id="_3-1-保证每次只有单个消费实例消费"><a href="#_3-1-保证每次只有单个消费实例消费" class="header-anchor">#</a> 3.1 保证每次只有单个消费实例消费</h3> <p>所以对于 <strong>需要保证顺序消费的业务，我们可以只部署一个消费者实例，然后设置 <code>RabbitMQ</code> 每次只推送一个消息，再开启手动 <code>ack</code> 即可。这样 <code>RabbitMQ</code>每次只会从队列推送一个消息过来，处理完成之后我们 <code>ack</code> 回应，再消费下一个，就能确保消息顺序性。</strong></p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">listener</span><span class="token punctuation">:</span>
      <span class="token key atrule">simple</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefetch</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment">#每次只推送一个消息</span>
        <span class="token key atrule">acknowledge-mode</span><span class="token punctuation">:</span> manual
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这样 <code>RabbitMQ</code> 每次只会从队列推送一个消息过来，处理完成之后我们 ack 回应，再消费下一个，就能确保消息顺序性。</p> <p><strong>但是这样的操作也会降低消费者的性能</strong>，一个消费者消费消息时，其他消费者会阻塞，所以很多场景下可能并不会采用这样的方案。</p> <p>所以一般会根据场景，<strong>制定一定的策略来解决消费顺序问题。</strong></p> <h3 id="_3-2-简单队列场景"><a href="#_3-2-简单队列场景" class="header-anchor">#</a> 3.2 简单队列场景</h3> <p>当 <code>RabbitMQ</code> 采用简单队列模式的时候,如果消费者采用多线程的方式来加速消息的处理,此时也会出现消息乱序的问题。</p> <p><img src="/xiaoze-blog/assets/img/image5.6916d3fb.png" alt="alt text"></p> <p><strong>多线程并发抢占</strong> 出现 <strong>消费乱序问题</strong>，将 <strong>消息ID</strong> 进行 <code>hash计算</code>，将相同值放入同一个内存队列，让指定线程执行，即可解决顺序消费问题。</p> <p><img src="/xiaoze-blog/assets/img/image6.d1b708e2.png" alt="alt text"></p> <h3 id="_3-3-工作队列场景"><a href="#_3-3-工作队列场景" class="header-anchor">#</a> 3.3 工作队列场景</h3> <p>当 <code>RabbitMQ</code>采用 <code>work Queue</code> 模式，此时只会有一个 <code>Queue</code> 但是会有多个 <code>Consumer</code>,同时多个<code>Consumer</code>直接是竞争关系，此时就会出现MQ消息乱序的问题。</p> <p><img src="/xiaoze-blog/assets/img/image7.54d0bc7e.png" alt="alt text"></p> <p>生产者根据 <strong>商品id计算hash值</strong>，对队列取余，将相同id的操作压入同一个队列。每个队列一个消费者就不会出现乱序情况。</p> <p><img src="/xiaoze-blog/assets/img/image8.ca340aee.png" alt="alt text"></p> <h3 id="_3-4-小节"><a href="#_3-4-小节" class="header-anchor">#</a> 3.4 小节</h3> <p>解决消费顺序问题，<strong>最根源的思路还是根据一定的策略，实现一个消费者按序处理一个队列中的消息。</strong></p> <h2 id="_4-消息积压问题"><a href="#_4-消息积压问题" class="header-anchor">#</a> 4. 消息积压问题</h2> <p>所谓消息积压一般是由于 <strong>消息生产的速度长时间，远远大于消费的速度时，导致大量消息在 RabbitMQ 的队列中无法消费。</strong></p> <h3 id="_4-1-消息积压的影响"><a href="#_4-1-消息积压的影响" class="header-anchor">#</a> 4.1 消息积压的影响</h3> <ul><li>可能导致新消息无法进入队列</li> <li>可能导致旧消息无法丢失</li> <li>消息等待消费的时间过长，超出了业务容忍范围。</li></ul> <h3 id="_4-2-产生堆积的情况"><a href="#_4-2-产生堆积的情况" class="header-anchor">#</a> 4.2 产生堆积的情况</h3> <ul><li>生产者突然大量发布消息</li> <li>消费者消费失败</li> <li>消费者出现性能瓶颈</li> <li>消费者挂掉</li></ul> <h3 id="_4-3场景重现"><a href="#_4-3场景重现" class="header-anchor">#</a> 4.3场景重现</h3> <ul><li><strong>生产者发送大量消息</strong>：利用Jmeter开多线程，循环发送大量消息进入队列。</li> <li><strong>消费者消费失败</strong>：自动ack情况下，抛出异常进行模拟。</li> <li><strong>设置消费者性能瓶颈</strong>：在消费方法中设置休眠时间，模拟性能瓶颈。</li> <li><strong>关闭消费者</strong>：停掉消费者，模拟消费者挂掉。</li></ul> <p><strong>消费者端</strong> 示例核心代码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginIntegralComsumer</span> <span class="token keyword">implements</span> <span class="token class-name">MessageListener</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> jsonString <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>
            jsonString <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnsupportedEncodingException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//模拟发生异常</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;模拟处理异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>
            <span class="token comment">//模拟耗时的处理过程</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;处理消息:&quot;</span><span class="token operator">+</span>jsonString<span class="token punctuation">)</span><span class="token punctuation">;</span>      
        <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="_4-4-解决办法"><a href="#_4-4-解决办法" class="header-anchor">#</a> 4.4 解决办法</h3> <ul><li>1、对生产者发消息接口进行适当限流（不太推荐，影响用户体验）</li> <li>2、多部署几台消费者实例（推荐）</li> <li>3、适当增加 <code>prefetch</code> 的数量，让消费端一次多接受一些消息（推荐，可以和第二种方案一起用）</li> <li>4、增加消费者的多线程处理</li> <li>5、死信队列</li></ul> <blockquote><p>常见处理思路</p></blockquote> <p>1、拆分MQ,生产者一个MQ，消费者一个MQ，写一个程序监听生产者的MQ模拟消费速度（譬如线程休眠），然后发送到消费者的MQ，如果消息积压则只需要处理生产者的MQ的积压消息，不影响消费者MQ</p> <p><img src="/xiaoze-blog/assets/img/image9.3da69378.png" alt="alt text"></p> <p>2、拆分MQ,生产者一个MQ，消费者一个MQ，写一个程序监听生产者的MQ，定义一个全局静态变量记录上一次消费的时间，如果上一次时间和当前时间只差小于消费者的处理时间，则发送到一个延迟队列（可以使用死信队列实现）发送到消费者的MQ，如果消息积压则只需要处理生产者的MQ的积压消息，不影响消费者MQ。</p> <p><img src="/xiaoze-blog/assets/img/image10.2d695b9e.png" alt="alt text"></p> <p>3、使用 <code>Redis</code> 的 <code>List</code> 或 <code>ZSET</code>做接收消息缓存，写一个程序按照消费者处理时间定时从Redis取消息发送到MQ</p> <p><img src="/xiaoze-blog/assets/img/image11.2392edc4.png" alt="alt text"></p> <p>4、<strong>设置消息过期时间</strong>，过期后转入 <strong>死信队列</strong>，写一个程序处理死信消息（重新入队列或者即使处理或记录到数据库延后处理）</p> <p><img src="/xiaoze-blog/assets/img/image12.c8a706d7.png" alt="alt text"></p></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/xiaoze-blog/blogs/后端/rabbitmq/1：RabbitMq.html" class="prev">
          1：RabbitMq
        </a></span> <span class="next"><a href="/xiaoze-blog/blogs/后端/rocketmq/1：RocketMq.html">
          1：RocketMq
        </a></span></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/xiaoze-blog/blogs/%E5%90%8E%E7%AB%AF/rabbitmq/2%EF%BC%9ARabbitmq%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#_1-rabbitmq的可靠性-消息丢失问题" class="sidebar-link reco-side-_1-rabbitmq的可靠性-消息丢失问题" data-v-b57cc07c>1. RabbitMQ的可靠性（消息丢失问题）</a></li><li class="level-3" data-v-b57cc07c><a href="/xiaoze-blog/blogs/%E5%90%8E%E7%AB%AF/rabbitmq/2%EF%BC%9ARabbitmq%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#_1-1-生产者丢失消息" class="sidebar-link reco-side-_1-1-生产者丢失消息" data-v-b57cc07c>1.1 生产者丢失消息</a></li><li class="level-3" data-v-b57cc07c><a href="/xiaoze-blog/blogs/%E5%90%8E%E7%AB%AF/rabbitmq/2%EF%BC%9ARabbitmq%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#_1-2-rabbitmq弄丢消息" class="sidebar-link reco-side-_1-2-rabbitmq弄丢消息" data-v-b57cc07c>1.2 Rabbitmq弄丢消息</a></li><li class="level-3" data-v-b57cc07c><a href="/xiaoze-blog/blogs/%E5%90%8E%E7%AB%AF/rabbitmq/2%EF%BC%9ARabbitmq%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#_1-3-消费者弄丢消息" class="sidebar-link reco-side-_1-3-消费者弄丢消息" data-v-b57cc07c>1.3 消费者弄丢消息</a></li><li class="level-3" data-v-b57cc07c><a href="/xiaoze-blog/blogs/%E5%90%8E%E7%AB%AF/rabbitmq/2%EF%BC%9ARabbitmq%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#_1-4-小节" class="sidebar-link reco-side-_1-4-小节" data-v-b57cc07c>1.4 小节</a></li><li class="level-2" data-v-b57cc07c><a href="/xiaoze-blog/blogs/%E5%90%8E%E7%AB%AF/rabbitmq/2%EF%BC%9ARabbitmq%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#_2-重复消费问题-消息幂等性" class="sidebar-link reco-side-_2-重复消费问题-消息幂等性" data-v-b57cc07c>2. 重复消费问题（消息幂等性）</a></li><li class="level-3" data-v-b57cc07c><a href="/xiaoze-blog/blogs/%E5%90%8E%E7%AB%AF/rabbitmq/2%EF%BC%9ARabbitmq%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#_2-1-生产时消息重复" class="sidebar-link reco-side-_2-1-生产时消息重复" data-v-b57cc07c>2.1 生产时消息重复</a></li><li class="level-3" data-v-b57cc07c><a href="/xiaoze-blog/blogs/%E5%90%8E%E7%AB%AF/rabbitmq/2%EF%BC%9ARabbitmq%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#_2-2-消费时消息重复" class="sidebar-link reco-side-_2-2-消费时消息重复" data-v-b57cc07c>2.2 消费时消息重复</a></li><li class="level-3" data-v-b57cc07c><a href="/xiaoze-blog/blogs/%E5%90%8E%E7%AB%AF/rabbitmq/2%EF%BC%9ARabbitmq%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#_2-3-示例" class="sidebar-link reco-side-_2-3-示例" data-v-b57cc07c>2.3 示例</a></li><li class="level-2" data-v-b57cc07c><a href="/xiaoze-blog/blogs/%E5%90%8E%E7%AB%AF/rabbitmq/2%EF%BC%9ARabbitmq%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#_3-消息消费顺序性问题" class="sidebar-link reco-side-_3-消息消费顺序性问题" data-v-b57cc07c>3. 消息消费顺序性问题</a></li><li class="level-3" data-v-b57cc07c><a href="/xiaoze-blog/blogs/%E5%90%8E%E7%AB%AF/rabbitmq/2%EF%BC%9ARabbitmq%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#_3-1-保证每次只有单个消费实例消费" class="sidebar-link reco-side-_3-1-保证每次只有单个消费实例消费" data-v-b57cc07c>3.1 保证每次只有单个消费实例消费</a></li><li class="level-3" data-v-b57cc07c><a href="/xiaoze-blog/blogs/%E5%90%8E%E7%AB%AF/rabbitmq/2%EF%BC%9ARabbitmq%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#_3-2-简单队列场景" class="sidebar-link reco-side-_3-2-简单队列场景" data-v-b57cc07c>3.2 简单队列场景</a></li><li class="level-3" data-v-b57cc07c><a href="/xiaoze-blog/blogs/%E5%90%8E%E7%AB%AF/rabbitmq/2%EF%BC%9ARabbitmq%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#_3-3-工作队列场景" class="sidebar-link reco-side-_3-3-工作队列场景" data-v-b57cc07c>3.3 工作队列场景</a></li><li class="level-3" data-v-b57cc07c><a href="/xiaoze-blog/blogs/%E5%90%8E%E7%AB%AF/rabbitmq/2%EF%BC%9ARabbitmq%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#_3-4-小节" class="sidebar-link reco-side-_3-4-小节" data-v-b57cc07c>3.4 小节</a></li><li class="level-2" data-v-b57cc07c><a href="/xiaoze-blog/blogs/%E5%90%8E%E7%AB%AF/rabbitmq/2%EF%BC%9ARabbitmq%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#_4-消息积压问题" class="sidebar-link reco-side-_4-消息积压问题" data-v-b57cc07c>4. 消息积压问题</a></li><li class="level-3" data-v-b57cc07c><a href="/xiaoze-blog/blogs/%E5%90%8E%E7%AB%AF/rabbitmq/2%EF%BC%9ARabbitmq%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#_4-1-消息积压的影响" class="sidebar-link reco-side-_4-1-消息积压的影响" data-v-b57cc07c>4.1 消息积压的影响</a></li><li class="level-3" data-v-b57cc07c><a href="/xiaoze-blog/blogs/%E5%90%8E%E7%AB%AF/rabbitmq/2%EF%BC%9ARabbitmq%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#_4-2-产生堆积的情况" class="sidebar-link reco-side-_4-2-产生堆积的情况" data-v-b57cc07c>4.2 产生堆积的情况</a></li><li class="level-3" data-v-b57cc07c><a href="/xiaoze-blog/blogs/%E5%90%8E%E7%AB%AF/rabbitmq/2%EF%BC%9ARabbitmq%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#_4-3场景重现" class="sidebar-link reco-side-_4-3场景重现" data-v-b57cc07c>4.3场景重现</a></li><li class="level-3" data-v-b57cc07c><a href="/xiaoze-blog/blogs/%E5%90%8E%E7%AB%AF/rabbitmq/2%EF%BC%9ARabbitmq%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html#_4-4-解决办法" class="sidebar-link reco-side-_4-4-解决办法" data-v-b57cc07c>4.4 解决办法</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><canvas id="vuepress-canvas-cursor"></canvas><div></div><div class="kanbanniang" data-v-5775ee02><div class="banniang-container" style="display:;" data-v-5775ee02><div class="messageBox" style="right:68px;bottom:190px;display:none;" data-v-5775ee02>
      欢迎来到 小泽认真奋进
    </div> <div class="operation" style="right:90px;bottom:40px;display:;" data-v-5775ee02><i class="kbnfont kbn-ban-home ban-home" data-v-5775ee02></i> <i class="kbnfont kbn-ban-message message" data-v-5775ee02></i> <i class="kbnfont kbn-ban-close close" data-v-5775ee02></i> <a target="_blank" href="https://vuepress-theme-reco.recoluan.com/views/plugins/kanbanniang.html" data-v-5775ee02><i class="kbnfont kbn-ban-info info" data-v-5775ee02></i></a> <i class="kbnfont kbn-ban-theme skin" style="display:;" data-v-5775ee02></i></div> <canvas id="banniang" width="150" height="220" class="live2d" style="right:90px;bottom:-20px;opacity:0.9;" data-v-5775ee02></canvas></div> <div class="showBanNiang" style="display:none;" data-v-5775ee02>
    看板娘
  </div></div><div class="Sakura" data-v-248d85d6><canvas id="canvas_sakura" style="z-index:999;" data-v-248d85d6></canvas></div></div></div>
    <script src="/xiaoze-blog/assets/js/app.acca6ad0.js" defer></script><script src="/xiaoze-blog/assets/js/11.29fd6443.js" defer></script><script src="/xiaoze-blog/assets/js/1.53f89df5.js" defer></script><script src="/xiaoze-blog/assets/js/31.a3e8b87d.js" defer></script>
  </body>
</html>
